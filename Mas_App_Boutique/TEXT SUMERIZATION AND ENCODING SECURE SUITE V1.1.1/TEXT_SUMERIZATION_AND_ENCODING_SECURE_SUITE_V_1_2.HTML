import React, { useState, useEffect } from 'react';
import { Upload, Zap, Binary, Copy, Check, Trash2, RefreshCcw, Download, Lock, ShieldCheck, X, AlertTriangle } from 'lucide-react';

const App = () => {
  const [input, setInput] = useState('');
  const [summary, setSummary] = useState('');
  const [capsule, setCapsule] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [copiedType, setCopiedType] = useState(null);
  const [dragActive, setDragActive] = useState(false);
  
  // Security State
  const [showKeypad, setShowKeypad] = useState(false);
  const [keypadMode, setKeypadMode] = useState(null); // 'create' or 'verify'
  const [pin, setPin] = useState('');
  const [targetPin, setTargetPin] = useState(null);
  const [attempts, setAttempts] = useState(0);
  const [isLockedOut, setIsLockedOut] = useState(false);
  const MAX_ATTEMPTS = 10;

  // Stealth Mapping: Maps PIN digits 0-9 to characters used in the encoding
  const stealthMap = ['@', '&', '$', '%', '*', '#', '~', '^', '+', '='];

  const apiKey = ""; 

  useEffect(() => {
    // Load external assets for font
    const link = document.createElement('link');
    link.href = 'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap';
    link.rel = 'stylesheet';
    document.head.appendChild(link);

    // Load PDF.js library for PDF text extraction
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js';
    script.onload = () => {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    };
    document.head.appendChild(script);
  }, []);

  const handleFileUpload = async (e) => {
    const file = e.target.files?.[0] || e.dataTransfer?.files?.[0];
    if (!file) return;

    if (file.type === "application/pdf") {
      setIsProcessing(true);
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join(" ") + "\n";
        }
        setInput(fullText);
      } catch (err) {
        console.error("PDF Load Error:", err);
      } finally {
        setIsProcessing(false);
      }
    } else {
      const reader = new FileReader();
      reader.onload = (event) => setInput(event.target.result);
      reader.readAsText(file);
    }
  };

  const downloadText = (text, filename) => {
    if (!text) return;
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const handleDrag = (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === "dragenter" || e.type === "dragover") setDragActive(true);
    else if (e.type === "dragleave") setDragActive(false);
  };

  const handleDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    handleFileUpload(e);
  };

  const pinToSymbols = (p) => {
    return p.split('').map(digit => stealthMap[parseInt(digit)]).join('');
  };

  const detectStealthPin = (str) => {
    if (str.length < 5) return null;
    const firstFour = str.substring(0, 4);
    let potentialPin = "";
    for (let char of firstFour) {
      const idx = stealthMap.indexOf(char);
      if (idx === -1) return null;
      potentialPin += idx.toString();
    }
    return potentialPin;
  };

  const handlePinInput = (num) => {
    if (isLockedOut) return;
    if (pin.length < 4) {
      const newPin = pin + num;
      setPin(newPin);
      if (newPin.length === 4) {
        setTimeout(() => finalizePinAction(newPin), 350);
      }
    }
  };

  const finalizePinAction = (completedPin) => {
    if (keypadMode === 'create') {
      processLogic('ENCODE', completedPin);
      closeKeypad();
    } else if (keypadMode === 'verify') {
      if (completedPin === targetPin) {
        setAttempts(0);
        processLogic('DECODE', null, true);
        closeKeypad();
      } else {
        const nextAttempts = attempts + 1;
        if (nextAttempts >= MAX_ATTEMPTS) {
          // Trigger total wipe on the final failed attempt
          resetSystem();
          closeKeypad();
        } else {
          setAttempts(nextAttempts);
          setPin(''); 
        }
      }
    }
  };

  const closeKeypad = () => {
    setShowKeypad(false);
    setPin('');
    setKeypadMode(null);
    setTargetPin(null);
  };

  const resetSystem = () => {
    setInput('');
    setSummary('');
    setCapsule('');
    setTargetPin(null);
    setAttempts(0);
    setIsLockedOut(false);
    setPin('');
  };

  const retryFetch = async (fn, retries = 5, delay = 1000) => {
    for (let i = 0; i < retries; i++) {
      try {
        return await fn();
      } catch (err) {
        if (i === retries - 1) throw err;
        await new Promise(r => setTimeout(r, delay * Math.pow(2, i)));
      }
    }
  };

  const processLogic = async (mode, securePin = null, skipCheck = false) => {
    const rawInput = input.trim();
    if (!rawInput) return;

    if (mode === 'DECODE' && !skipCheck) {
      const detected = detectStealthPin(rawInput);
      if (detected) {
        setTargetPin(detected);
        setKeypadMode('verify');
        setShowKeypad(true);
        return;
      }
    }

    setIsProcessing(true);

    try {
      if (mode === 'ENCODE') {
        const systemPrompt = `PROTOCOL: DYNAMIC RATIO-BASED DISTILLATION & ENCODING
        GOAL: Summarize Input into Box 2 then compress into Box 3.
        Rules: Box 2 must be coherent English. Box 3 must be symbolic shorthand using @, &, $, %, *, #, ~, ^, +, =, >.
        Return ONLY JSON: {"summary": "...", "capsule": "..."}`;

        const response = await retryFetch(() => 
          fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            body: JSON.stringify({
              contents: [{ parts: [{ text: input }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: { responseMimeType: "application/json" }
            })
          }).then(res => res.json())
        );

        const result = JSON.parse(response.candidates[0].content.parts[0].text);
        setSummary(result.summary);
        
        if (securePin) {
          const stealthPrefix = pinToSymbols(securePin);
          setCapsule(`${stealthPrefix}${result.capsule}`);
        } else {
          setCapsule(result.capsule);
        }
      } else {
        const hasPin = detectStealthPin(rawInput);
        const cleanInput = hasPin ? rawInput.substring(4) : rawInput;
        
        const systemPrompt = `PROTOCOL: RECURSIVE DOUBLE-DECODING (FDC-2)
        Restore symbolic Micro-Capsule back to high-density English.
        Return ONLY JSON: {"summary": "Step 2 reconstructed text", "capsule": "original input symbol string"}`;

        const response = await retryFetch(() => 
          fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            body: JSON.stringify({
              contents: [{ parts: [{ text: cleanInput }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: { responseMimeType: "application/json" }
            })
          }).then(res => res.json())
        );

        const result = JSON.parse(response.candidates[0].content.parts[0].text);
        setSummary(result.summary);
        setCapsule(input); 
      }
    } catch (error) {
      setSummary("Processing Error: Unable to complete logic loop.");
    } finally {
      setIsProcessing(false);
    }
  };

  const copyToClipboard = (text, type) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    setCopiedType(type);
    setTimeout(() => setCopiedType(null), 2000);
  };

  const textColor = '#FFFFFF';
  const subtleRed = '#E57373';

  return (
    <div className="min-h-screen bg-black p-4 md:p-8 font-sans flex flex-col" style={{ color: textColor }}>
      
      {/* SECURITY OVERLAY (KEYPAD) */}
      {showKeypad && (
        <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex items-center justify-center p-4">
          <div className={`bg-neutral-900 border border-neutral-800 p-8 rounded-[2.5rem] w-full max-w-xs shadow-2xl relative border-t-white/10 transition-all ${isLockedOut ? 'border-red-900/50' : ''}`}>
            {!isLockedOut && (
              <button onClick={closeKeypad} className="absolute top-6 right-6 text-neutral-500 hover:text-white transition-colors">
                <X size={24} />
              </button>
            )}
            
            <div className="text-center mb-8">
              <div className={`inline-flex p-4 rounded-3xl mb-4 border ${isLockedOut ? 'bg-red-500/10 border-red-500/20 text-red-500' : 'bg-white/5 border-white/5 text-white'}`}>
                {isLockedOut ? <AlertTriangle size={28} /> : (keypadMode === 'create' ? <Lock size={28} /> : <ShieldCheck size={28} />)}
              </div>
              <h2 className="text-2xl font-bold uppercase tracking-widest" style={{ fontFamily: "'Playfair Display', serif" }}>
                {isLockedOut ? 'System Locked' : (keypadMode === 'create' ? 'Secure Setup' : 'Access Gate')}
              </h2>
              <p className={`text-[10px] uppercase mt-2 tracking-[0.2em] font-bold ${isLockedOut ? 'text-red-500' : 'text-neutral-500'}`}>
                {isLockedOut ? 'Attempts Exceeded' : (keypadMode === 'create' ? 'Assign 4-Digit Protection' : 'Identification Required')}
              </p>
            </div>
            
            {!isLockedOut ? (
              <>
                <div className="flex justify-center gap-5 mb-10">
                  {[0, 1, 2, 3].map((i) => (
                    <div key={i} className={`w-4 h-4 rounded-full border border-white/20 transition-all duration-300 ${pin.length > i ? 'bg-white shadow-[0_0_15px_rgba(255,255,255,0.5)] scale-110' : ''}`} />
                  ))}
                </div>

                <div className="grid grid-cols-3 gap-4">
                  {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'CLR', 0, ''].map((btn, idx) => (
                    <button
                      key={idx}
                      disabled={btn === ''}
                      onClick={() => {
                        if (btn === 'CLR') setPin('');
                        else if (btn !== '') handlePinInput(btn.toString());
                      }}
                      className={`h-16 flex items-center justify-center rounded-2xl text-2xl font-bold transition-all active:scale-90 ${
                        btn === '' ? 'opacity-0' : 'bg-white/5 hover:bg-white/10 border border-white/5'
                      } ${btn === 'CLR' ? 'text-xs uppercase tracking-widest' : ''}`}
                    >
                      {btn}
                    </button>
                  ))}
                </div>

                {keypadMode === 'verify' && (
                  <div className="mt-8 text-center">
                    <p className="text-[9px] uppercase tracking-[0.25em] font-black opacity-30">
                      Attempt {attempts + 1} of {MAX_ATTEMPTS}
                    </p>
                  </div>
                )}
              </>
            ) : (
              <div className="text-center space-y-6 mt-4">
                <p className="text-xs text-neutral-400 leading-relaxed uppercase tracking-widest">
                  Security protocol activated. Manual system override required.
                </p>
                <button 
                  onClick={resetSystem}
                  className="w-full py-4 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20 rounded-2xl text-xs font-black uppercase tracking-widest transition-all"
                >
                  Full System Reset
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      <div className="max-w-6xl mx-auto space-y-6 flex-grow w-full">
        <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-neutral-800 pb-6">
          <div className="flex-1 min-w-0">
            <h1 
              className="text-xl sm:text-2xl md:text-3xl lg:text-4xl uppercase tracking-tighter flex items-center gap-2 whitespace-nowrap overflow-hidden"
              style={{ 
                fontFamily: "'Playfair Display', serif", 
                fontWeight: 900,
                color: textColor,
                textShadow: '0px 2px 4px rgba(0,0,0,0.5)',
              }}
            >
              Text Summarization & Encoding Suite
            </h1>
            <div className="h-4 mt-2" />
          </div>
          <div className="flex items-center gap-4 shrink-0">
            <button 
              onClick={resetSystem}
              className="group flex items-center gap-2 px-4 py-2 bg-neutral-900 hover:bg-neutral-800 border border-neutral-800 hover:border-neutral-700 rounded-full transition-all shadow-lg"
            >
              <RefreshCcw size={16} className="group-hover:rotate-180 transition-transform duration-500" />
              <span className="text-xs font-bold uppercase tracking-widest">Reset System</span>
            </button>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div className="space-y-4">
            <div 
              className={`relative group border-2 border-dashed rounded-[2.5rem] transition-all h-80 flex flex-col overflow-hidden ${
                dragActive ? 'border-white bg-white/5' : 'border-neutral-800 hover:border-neutral-700 bg-neutral-900/40'
              }`}
              onDragEnter={handleDrag}
              onDragLeave={handleDrag}
              onDragOver={handleDrag}
              onDrop={handleDrop}
            >
              <textarea
                value={input}
                onChange={(e) => setInput(e.target.value)}
                placeholder="Type text, drop/paste content or PDF here..."
                className="flex-1 bg-transparent p-10 outline-none resize-none leading-relaxed text-lg"
                style={{ color: textColor, '--tw-placeholder-opacity': '0.2' }}
              />
              <div className="absolute bottom-8 right-8 flex gap-3">
                <label className="cursor-pointer bg-neutral-800 hover:bg-neutral-700 px-6 py-3 rounded-2xl transition-all flex flex-col items-center justify-center border border-neutral-700 shadow-2xl group min-w-[140px] h-16">
                  <div className="flex items-center gap-2 text-xs font-black uppercase tracking-tighter">
                    <Upload size={14} /> Import File
                  </div>
                  <span className="text-[9px] text-neutral-500 font-bold uppercase tracking-widest mt-0.5 opacity-60 group-hover:opacity-100 transition-opacity">
                    .pdf .txt .md .json
                  </span>
                  <input type="file" className="hidden" accept=".txt,.md,.json,.pdf" onChange={handleFileUpload} />
                </label>
              </div>
              {input && (
                <button 
                  onClick={() => setInput('')}
                  className="absolute top-8 right-8 p-3 bg-neutral-800/50 hover:bg-red-900/50 rounded-2xl transition-all"
                >
                  <Trash2 size={18} />
                </button>
              )}
            </div>

            <div className="flex flex-col gap-4">
              <div className="grid grid-cols-2 gap-4">
                <button
                  onClick={() => processLogic('ENCODE')}
                  disabled={isProcessing || !input}
                  className="group bg-white hover:bg-neutral-200 disabled:opacity-30 font-black py-5 rounded-3xl transition-all flex items-center justify-center gap-3 shadow-xl active:scale-95"
                  style={{ color: subtleRed }}
                >
                  {isProcessing ? <div className="animate-spin rounded-full h-6 w-6 border-2 border-current border-t-transparent" /> : <>SUMMARIZE & ENCODE <Zap size={20} fill="currentColor" /></>}
                </button>
                <button
                  onClick={() => processLogic('DECODE')}
                  disabled={isProcessing || !input}
                  className="bg-neutral-100 hover:bg-white disabled:opacity-30 font-black py-5 rounded-3xl transition-all flex items-center justify-center gap-3 active:scale-95 shadow-xl"
                  style={{ color: subtleRed }}
                >
                  {isProcessing ? <div className="animate-spin rounded-full h-6 w-6 border-2 border-current border-t-transparent" /> : <>DECODE DATA <Binary size={20} /></>}
                </button>
              </div>
              
              <button
                onClick={() => { setKeypadMode('create'); setShowKeypad(true); }}
                disabled={isProcessing || !input}
                className="group bg-neutral-900 hover:bg-neutral-800 border border-white/10 hover:border-white/30 font-black py-5 rounded-3xl transition-all flex items-center justify-center gap-4 shadow-2xl active:scale-95 uppercase tracking-[0.2em] text-xs"
              >
                <Lock size={18} className="text-white" /> SECURELY SUMMARIZE & ENCODE
              </button>
            </div>
          </div>

          <div className="space-y-6 flex flex-col h-full">
            <div className="flex-1 bg-neutral-950 border border-neutral-800 rounded-[2.5rem] flex flex-col overflow-hidden shadow-2xl">
              <div className="bg-neutral-900/50 px-8 py-5 flex justify-between items-center border-b border-neutral-800">
                <div className="flex items-center gap-4">
                  <div className="w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse" />
                  <span className="text-[11px] font-black tracking-widest uppercase opacity-70">Semantic Summary</span>
                </div>
                {summary && (
                  <div className="flex items-center gap-2">
                    <button onClick={() => downloadText(summary, 'summary.txt')} className="p-2 hover:bg-neutral-800 rounded-xl transition-colors"><Download size={18} /></button>
                    <button onClick={() => copyToClipboard(summary, 'summary')} className="p-2 hover:bg-neutral-800 rounded-xl transition-colors">
                      {copiedType === 'summary' ? <Check size={18} className="text-green-400" /> : <Copy size={18} />}
                    </button>
                  </div>
                )}
              </div>
              <div className="p-10 flex-1 overflow-y-auto leading-relaxed text-xl font-serif italic selection:bg-white/10">
                {summary || <span className="non-italic font-sans text-sm opacity-10">System idle. Semantic stream ready.</span>}
              </div>
            </div>

            <div className="bg-neutral-950 border border-neutral-800 rounded-[2rem] flex flex-col h-44 overflow-hidden shrink-0 shadow-2xl">
              <div className="bg-neutral-900/50 px-8 py-4 flex justify-between items-center border-b border-neutral-800">
                <div className="flex items-center gap-4">
                  <div className="w-2.5 h-2.5 rounded-full bg-white" />
                  <span className="text-[11px] font-black tracking-widest uppercase opacity-70">Encoded Capsule</span>
                </div>
                {capsule && (
                  <div className="flex items-center gap-2">
                    <button onClick={() => downloadText(capsule, 'encoded_capsule.txt')} className="p-2 hover:bg-neutral-800 rounded-xl transition-colors"><Download size={18} /></button>
                    <button onClick={() => copyToClipboard(capsule, 'capsule')} className="p-2 hover:bg-neutral-800 rounded-xl transition-colors">
                      {copiedType === 'capsule' ? <Check size={18} className="text-green-400" /> : <Copy size={18} />}
                    </button>
                  </div>
                )}
              </div>
              <div className="p-8 flex-1 font-mono break-all text-xs tracking-[0.4em] overflow-y-auto bg-[radial-gradient(circle_at_top_right,_rgba(255,255,255,0.05),transparent)]">
                {capsule || <span className="tracking-normal text-xs opacity-10">Shorthand buffer empty.</span>}
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer className="mt-10 pt-8 border-t border-neutral-900 text-center space-y-3 opacity-40 hover:opacity-100 transition-all">
        <p className="text-sm tracking-[0.3em] uppercase font-bold">Created and encoded by Barry Curran - the Architect</p>
        <p className="text-[10px] tracking-tight uppercase max-w-2xl mx-auto leading-relaxed">
          Software licensed under CC BY-NC-ND 4.0
          <br /> Personal non-commercial use only â€¢ No unauthorized distribution or derivative works permitted
        </p>
      </footer>
    </div>
  );
};

export default App;