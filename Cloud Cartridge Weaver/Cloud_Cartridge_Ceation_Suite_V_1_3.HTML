<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Cartridge Creation Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-font {
            font-family: 'Fira Code', monospace;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #38bdf8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #preview-frame {
            background: white;
            border-radius: 12px;
            width: 100%;
            height: 100%;
            min-height: 800px;
            border: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: block;
        }

        .preview-scroll-container {
            flex: 1;
            overflow-y: auto;
            border-radius: 12px;
            padding-bottom: 50px;
        }

        .preview-scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .preview-scroll-container::-webkit-scrollbar-track {
            background: #0f172a;
        }
        .preview-scroll-container::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        .preview-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #38bdf8;
        }

        .suggestion-chip {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid rgba(56, 189, 248, 0.2);
            animation: slideIn 0.3s ease-out forwards;
        }
        .suggestion-chip:hover {
            background: rgba(56, 189, 248, 0.1);
            border-color: #38bdf8;
            transform: translateX(4px);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #drop-zone.dragover {
            background: rgba(56, 189, 248, 0.1);
            border-color: #38bdf8;
            border-style: solid;
        }

        /* Header Input Styles */
        .header-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(56, 189, 248, 0.3);
            color: #38bdf8;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .header-input:focus {
            border-color: #38bdf8;
            background: rgba(15, 23, 42, 0.9);
            outline: none;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <header class="p-4 border-b border-slate-700 glass flex justify-between items-center z-50">
        <div class="flex items-center gap-3">
            <div class="bg-sky-500 p-2 rounded-lg shadow-lg shadow-sky-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 10V7a2 2 0 00-2-2h-2a2 2 0 00-2 2v10m7-10H9" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-semibold tracking-tight">Cloud Cartridge Creation Suite</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Logic Weaver V1.3</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- NEW HEADER NAMING BOX -->
            <div id="header-naming-container" class="hidden animate-in fade-in slide-in-from-right-4 duration-500">
                <div class="flex items-center gap-2">
                    <label for="header-project-name" class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">Name Program:</label>
                    <input type="text" id="header-project-name" 
                        placeholder="filename"
                        oninput="syncNames(this.value, 'project-name')"
                        class="header-input px-3 py-1.5 rounded-md text-sm w-48">
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="resetWorkspace()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-md text-xs font-medium transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    New Program
                </button>
                <button id="download-btn" class="hidden px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-md text-sm font-medium transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Save HTML
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <section id="editor-pane" class="w-full md:w-1/2 flex flex-col border-r border-slate-700 bg-slate-900/50">
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                
                <!-- STARTING INPUTS -->
                <div id="input-selection" class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Create New Logic</label>
                        <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700 shadow-inner">
                            <textarea id="user-prompt" 
                                placeholder="Example: 'Make a full screen pomodoro timer with a dark synthwave theme...'"
                                class="w-full h-24 bg-transparent text-slate-200 outline-none resize-none placeholder:text-slate-600"></textarea>
                        </div>
                    </div>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-800"></div></div>
                        <div class="relative flex justify-center text-[10px] uppercase font-bold text-slate-600">
                            <span class="bg-[#0f172a] px-2 tracking-widest">OR</span>
                        </div>
                    </div>

                    <div id="drop-zone" class="border-2 border-dashed border-slate-700 rounded-2xl p-8 flex flex-col items-center justify-center gap-3 transition-all cursor-pointer hover:border-sky-500/50 group">
                        <div class="text-center space-y-2">
                            <p class="text-sm font-semibold text-slate-300">Drag and drop an existing HTML file here</p>
                            <p class="text-[11px] text-slate-500 leading-relaxed max-w-xs mx-auto">
                                You can import an existing HTML file by dragging and dropping it below. 
                            </p>
                        </div>
                        <input type="file" id="file-input" class="hidden" accept=".html">
                    </div>
                </div>

                <!-- PROJECT CONFIGURATION (Naming and Edits) -->
                <div id="suggestions-container" class="hidden space-y-6 animate-in fade-in duration-500">
                    
                    <!-- SIDEBAR FILE NAMING BOX -->
                    <div class="space-y-2 bg-sky-950/20 p-4 rounded-2xl border border-sky-500/20">
                        <label class="text-xs font-bold text-sky-400 uppercase tracking-widest flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            Naming your Creation
                        </label>
                        <input type="text" id="project-name" 
                            placeholder="my-awesome-program"
                            oninput="syncNames(this.value, 'header-project-name')"
                            class="w-full bg-slate-900/80 text-slate-200 outline-none p-3 rounded-xl border border-slate-700 font-medium placeholder:text-slate-600 focus:border-sky-500 transition-colors">
                        <p class="text-[10px] text-slate-500 italic">This will be used as the filename when you save.</p>
                    </div>

                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-sky-400 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 bg-sky-400 rounded-full animate-pulse"></span>
                            AI Refinement Suggestions
                        </label>
                        <div id="suggestions-list" class="grid gap-2"></div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Refinement & Edits</label>
                        <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                            <textarea id="edit-prompt" 
                                placeholder="Type your edits or click a suggestion above..."
                                class="w-full h-32 bg-transparent text-slate-200 outline-none resize-none placeholder:text-slate-700"></textarea>
                        </div>
                    </div>
                </div>

                <div id="status-area" class="hidden glass p-4 rounded-xl border-sky-500/30 flex items-center gap-3">
                    <div class="spinner"></div>
                    <p id="status-text" class="text-sm text-sky-400 font-medium"></p>
                </div>

                <div id="code-output-container" class="hidden space-y-2">
                    <pre id="code-output" class="code-font text-[10px] bg-black/50 p-4 rounded-xl border border-slate-800 overflow-x-auto text-sky-500/80 max-h-48"></pre>
                </div>
            </div>

            <div class="p-6 bg-slate-900 border-t border-slate-800">
                <button id="weave-btn" onclick="processLogic()" class="w-full py-4 bg-sky-600 hover:bg-sky-500 rounded-xl font-bold shadow-lg shadow-sky-500/10 transition-all flex items-center justify-center gap-2">
                    <span id="btn-text">WEAVE LOGIC</span>
                </button>
            </div>
        </section>

        <section id="preview-pane" class="hidden md:flex flex-1 bg-slate-950 p-6 flex-col overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-600 uppercase tracking-widest">Live Preview</span>
                    <span class="text-[10px] bg-sky-500/20 text-sky-400 px-2 py-0.5 rounded border border-sky-500/30">Scrollable</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('preview-container').scrollTo({top:0, behavior:'smooth'})" class="text-[10px] text-slate-500 hover:text-white uppercase">Scroll to top</button>
                    <button onclick="copyCode()" class="text-[10px] text-sky-400 hover:underline uppercase">Copy Code</button>
                </div>
            </div>
            
            <div id="preview-container" class="preview-scroll-container">
                <div id="empty-state" class="h-full flex items-center justify-center text-slate-800">
                    <span class="text-sm italic">Waiting for Weaver...</span>
                </div>
                <iframe id="preview-frame" class="hidden"></iframe>
            </div>
        </section>
    </main>

    <script>
        const apiKey = ""; 
        let currentCode = "";
        let isEditMode = false;

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('bg-sky-500/10'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('bg-sky-500/10'); };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.html')) handleFile(file);
        };

        fileInput.onchange = (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); };

        function syncNames(val, otherId) {
            document.getElementById(otherId).value = val;
        }

        function resetWorkspace() {
            currentCode = "";
            isEditMode = false;
            
            document.getElementById('user-prompt').value = "";
            document.getElementById('edit-prompt').value = "";
            document.getElementById('project-name').value = "";
            document.getElementById('header-project-name').value = "";
            document.getElementById('code-output').innerText = "";
            document.getElementById('suggestions-list').innerHTML = "";
            
            document.getElementById('input-selection').classList.remove('hidden');
            document.getElementById('suggestions-container').classList.add('hidden');
            document.getElementById('header-naming-container').classList.add('hidden');
            document.getElementById('code-output-container').classList.add('hidden');
            document.getElementById('download-btn').classList.add('hidden');
            document.getElementById('preview-pane').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('preview-frame').classList.add('hidden');
            document.getElementById('preview-frame').srcdoc = "";
            
            document.getElementById('btn-text').innerText = "WEAVE LOGIC";
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentCode = e.target.result;
                const fileName = file.name.replace('.html', '');
                document.getElementById('project-name').value = fileName;
                document.getElementById('header-project-name').value = fileName;
                setupEditMode(currentCode);
                generateSuggestions(currentCode);
            };
            reader.readAsText(file);
        }

        function setupEditMode(code) {
            isEditMode = true;
            document.getElementById('input-selection').classList.add('hidden');
            document.getElementById('suggestions-container').classList.remove('hidden');
            document.getElementById('header-naming-container').classList.remove('hidden');
            document.getElementById('code-output-container').classList.remove('hidden');
            document.getElementById('code-output').innerText = code;
            
            const frame = document.getElementById('preview-frame');
            frame.srcdoc = code;
            frame.classList.remove('hidden');
            
            document.getElementById('preview-pane').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('download-btn').classList.remove('hidden');
            document.getElementById('btn-text').innerText = "APPLY EDITS";
        }

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (err) {
                if (retries <= 0) throw err;
                await new Promise(r => setTimeout(r, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
        }

        async function processLogic() {
            const prompt = isEditMode ? document.getElementById('edit-prompt').value : document.getElementById('user-prompt').value;
            if (!prompt && !isEditMode) return;

            const statusArea = document.getElementById('status-area');
            const statusText = document.getElementById('status-text');
            statusArea.classList.remove('hidden');
            statusText.innerText = "Weaving logic...";

            const systemPrompt = `TASK: Generate a single-file HTML/CSS/JS web application based on user logic.
STRICT RULE 1: Your response MUST be valid JSON with the format: { "code": "string_of_actual_code", "suggestions": ["string", "string", "string"] }.
STRICT RULE 2: The "code" field must contain ONLY functional source code.
STRICT RULE 3: Do not explain the code. Use the "suggestions" field for improvement ideas.`;

            const userQuery = isEditMode 
                ? `Update this program: ${currentCode}\nChanges requested: ${prompt}` 
                : `Create a new program: ${prompt}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { 
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            code: { type: "STRING" },
                            suggestions: { type: "ARRAY", items: { type: "STRING" } }
                        }
                    }
                }
            };

            try {
                const data = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );
                
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                currentCode = result.code;
                setupEditMode(currentCode);
                updateSuggestions(result.suggestions);
                document.getElementById('edit-prompt').value = "";
            } catch (e) {
                statusText.innerText = "Connection failed. Logic weave interrupted.";
            } finally {
                statusArea.classList.add('hidden');
            }
        }

        async function generateSuggestions(code) {
            const systemPrompt = `Analyze HTML code and return 3 concise improvement suggestions in JSON: { "suggestions": [string, string, string] }`;
            const payload = {
                contents: [{ parts: [{ text: `Code to analyze: ${code}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { 
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            suggestions: { type: "ARRAY", items: { type: "STRING" } }
                        }
                    }
                }
            };

            try {
                const data = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                updateSuggestions(result.suggestions);
            } catch (e) {}
        }

        function updateSuggestions(suggestions) {
            const list = document.getElementById('suggestions-list');
            list.innerHTML = "";
            suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = "suggestion-chip text-xs bg-slate-800/60 p-3 rounded-xl text-slate-300 hover:text-sky-400 flex items-start gap-2 border border-slate-700";
                div.innerHTML = `<span class="text-sky-500">âœ¦</span> <span>${s}</span>`;
                div.onclick = () => {
                    const current = document.getElementById('edit-prompt').value;
                    document.getElementById('edit-prompt').value = current ? `${current}\n${s}` : s;
                    document.getElementById('edit-prompt').focus();
                };
                list.appendChild(div);
            });
        }

        function copyCode() {
            const el = document.createElement('textarea');
            el.value = currentCode;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }

        document.getElementById('download-btn').onclick = () => {
            // Priority given to the header naming box, then fallback to sidebar
            let fileName = document.getElementById('header-project-name').value.trim() || document.getElementById('project-name').value.trim();
            
            if (!fileName) {
                const date = new Date().toISOString().split('T')[0];
                fileName = `cartridge_${date}`;
            }
            
            // Clean up name
            fileName = fileName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            if (!fileName.toLowerCase().endsWith('.html')) fileName += '.html';

            const blob = new Blob([currentCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; 
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>