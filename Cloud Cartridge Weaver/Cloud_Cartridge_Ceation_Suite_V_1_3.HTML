<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Cartridge Creation Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-font {
            font-family: 'Fira Code', monospace;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #38bdf8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SCROLLABLE PREVIEW FIX */
        #preview-frame {
            background: white;
            border-radius: 12px;
            width: 100%;
            height: 100%; /* Fill container */
            min-height: 800px; /* Ensure there is "room" to exist */
            border: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: block;
        }

        /* Container that allows the iframe to be scrolled if the content is long */
        .preview-scroll-container {
            flex: 1;
            overflow-y: auto; /* THIS IS THE FIX: Allows scrolling the preview pane */
            border-radius: 12px;
            padding-bottom: 50px; /* Padding for the bottom so buttons aren't cut off */
        }

        /* Custom scrollbar for a premium look */
        .preview-scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .preview-scroll-container::-webkit-scrollbar-track {
            background: #0f172a;
        }
        .preview-scroll-container::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        .preview-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #38bdf8;
        }

        .suggestion-chip {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid rgba(56, 189, 248, 0.2);
            animation: slideIn 0.3s ease-out forwards;
        }
        .suggestion-chip:hover {
            background: rgba(56, 189, 248, 0.1);
            border-color: #38bdf8;
            transform: translateX(4px);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #drop-zone.dragover {
            background: rgba(56, 189, 248, 0.1);
            border-color: #38bdf8;
            border-style: solid;
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="p-4 border-b border-slate-700 glass flex justify-between items-center z-50">
        <div class="flex items-center gap-3">
            <div class="bg-sky-500 p-2 rounded-lg shadow-lg shadow-sky-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 10V7a2 2 0 00-2-2h-2a2 2 0 00-2 2v10m7-10H9" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-semibold tracking-tight">Cloud Cartridge Creation Suite</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Logic Weaver V1.3</p>
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="location.reload()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-md text-xs font-medium transition-all">
                New Program
            </button>
            <button id="download-btn" class="hidden px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-md text-sm font-medium transition-all">
                Save HTML
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <!-- Workspace (Left Side) -->
        <section id="editor-pane" class="w-full md:w-1/2 flex flex-col border-r border-slate-700 bg-slate-900/50">
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                
                <!-- Input Selection -->
                <div id="input-selection" class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Create New Logic</label>
                        <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700 shadow-inner">
                            <textarea id="user-prompt" 
                                placeholder="Example: 'Make a full screen pomodoro timer with a dark synthwave theme...'"
                                class="w-full h-24 bg-transparent text-slate-200 outline-none resize-none placeholder:text-slate-600"></textarea>
                        </div>
                    </div>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-800"></div></div>
                        <div class="relative flex justify-center text-[10px] uppercase font-bold text-slate-600">
                            <span class="bg-[#0f172a] px-2 tracking-widest">OR</span>
                        </div>
                    </div>

                    <!-- DROP ZONE -->
                    <div id="drop-zone" class="border-2 border-dashed border-slate-700 rounded-2xl p-8 flex flex-col items-center justify-center gap-3 transition-all cursor-pointer hover:border-sky-500/50 group">
                        <div class="text-center space-y-2">
                            <p class="text-sm font-semibold text-slate-300">Drag and drop an existing HTML file here</p>
                            <p class="text-[11px] text-slate-500 leading-relaxed max-w-xs mx-auto">
                                You can import an existing HTML file by dragging and dropping it below. 
                            </p>
                        </div>
                        <input type="file" id="file-input" class="hidden" accept=".html">
                    </div>
                </div>

                <!-- PERSISTENT SUGGESTIONS AREA (Visible after generation) -->
                <div id="suggestions-container" class="hidden space-y-4 animate-in fade-in duration-500">
                    
                    <!-- FILENAME FIELD -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-sky-400 uppercase tracking-widest">Project Name (Filename)</label>
                        <div class="bg-slate-800/80 rounded-xl p-3 border border-slate-700">
                            <input type="text" id="project-name" 
                                placeholder="my-awesome-app"
                                class="w-full bg-transparent text-slate-200 outline-none placeholder:text-slate-600 font-medium">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-sky-400 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 bg-sky-400 rounded-full animate-pulse"></span>
                            AI Refinement Suggestions
                        </label>
                        <div id="suggestions-list" class="grid gap-2">
                            <!-- Suggestions populate here -->
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Refinement & Edits</label>
                        <div class="bg-sky-950/20 rounded-2xl p-4 border border-sky-500/30 shadow-lg shadow-sky-500/5">
                            <textarea id="edit-prompt" 
                                placeholder="Type your edits or click a suggestion above..."
                                class="w-full h-32 bg-transparent text-slate-200 outline-none resize-none placeholder:text-slate-700"></textarea>
                        </div>
                    </div>
                </div>

                <div id="status-area" class="hidden glass p-4 rounded-xl border-sky-500/30 flex items-center gap-3">
                    <div class="spinner"></div>
                    <p id="status-text" class="text-sm text-sky-400 font-medium"></p>
                </div>

                <div id="code-output-container" class="hidden space-y-2">
                    <pre id="code-output" class="code-font text-[10px] bg-black/50 p-4 rounded-xl border border-slate-800 overflow-x-auto text-sky-500/80 max-h-48"></pre>
                </div>
            </div>

            <div class="p-6 bg-slate-900 border-t border-slate-800">
                <button id="weave-btn" onclick="processLogic()" class="w-full py-4 bg-sky-600 hover:bg-sky-500 rounded-xl font-bold shadow-lg shadow-sky-500/10 transition-all flex items-center justify-center gap-2">
                    <span id="btn-text">WEAVE LOGIC</span>
                </button>
            </div>
        </section>

        <!-- Preview (Right Side) -->
        <section id="preview-pane" class="hidden md:flex flex-1 bg-slate-950 p-6 flex-col overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-600 uppercase tracking-widest">Live Preview</span>
                    <span class="text-[10px] bg-sky-500/20 text-sky-400 px-2 py-0.5 rounded border border-sky-500/30">Scrollable</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('preview-container').scrollTo({top:0, behavior:'smooth'})" class="text-[10px] text-slate-500 hover:text-white uppercase">Scroll to top</button>
                    <button onclick="copyCode()" class="text-[10px] text-sky-400 hover:underline uppercase">Copy Code</button>
                </div>
            </div>
            
            <!-- This container allows the user to scroll through the generated app -->
            <div id="preview-container" class="preview-scroll-container">
                <div id="empty-state" class="h-full flex items-center justify-center text-slate-800">
                    <span class="text-sm italic">Waiting for Weaver...</span>
                </div>
                <iframe id="preview-frame" class="hidden"></iframe>
            </div>
        </section>
    </main>

    <script>
        const apiKey = "";
        let currentCode = "";
        let isEditMode = false;

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('bg-sky-500/10'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('bg-sky-500/10'); };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.html')) handleFile(file);
        };

        fileInput.onchange = (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); };

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentCode = e.target.result;
                const fileName = file.name.replace('.html', '');
                document.getElementById('project-name').value = fileName;
                setupEditMode(currentCode);
                generateSuggestions(currentCode);
            };
            reader.readAsText(file);
        }

        function setupEditMode(code) {
            isEditMode = true;
            document.getElementById('input-selection').classList.add('hidden');
            document.getElementById('suggestions-container').classList.remove('hidden');
            document.getElementById('code-output-container').classList.remove('hidden');
            document.getElementById('code-output').innerText = code;
            
            const frame = document.getElementById('preview-frame');
            frame.srcdoc = code;
            frame.classList.remove('hidden');
            
            document.getElementById('preview-pane').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('download-btn').classList.remove('hidden');
            document.getElementById('btn-text').innerText = "APPLY EDITS";
        }

        async function processLogic() {
            const prompt = isEditMode ? document.getElementById('edit-prompt').value : document.getElementById('user-prompt').value;
            if (!prompt && !isEditMode) return;

            const statusArea = document.getElementById('status-area');
            const statusText = document.getElementById('status-text');
            statusArea.classList.remove('hidden');
            statusText.innerText = "Weaving logic...";

            const system = `TASK: Generate a single-file HTML/CSS/JS web application based on user logic.
STRICT RULE 1: Your response MUST be valid JSON with the format: { "code": "string_of_actual_code", "suggestions": ["string", "string", "string"] }.
STRICT RULE 2: The "code" field must contain ONLY functional source code.
STRICT RULE 3: Do not explain the code. Use the "suggestions" field for improvement ideas.`;

            const body = isEditMode 
                ? `Update this program: ${currentCode}\nChanges requested: ${prompt}` 
                : `Create a new program: ${prompt}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: body }] }],
                        systemInstruction: { parts: [{ text: system }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await res.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                
                currentCode = result.code;
                setupEditMode(currentCode);
                updateSuggestions(result.suggestions);
                document.getElementById('edit-prompt').value = "";
            } catch (e) {
                statusText.innerText = "Error in logic weave. Please try again.";
            } finally {
                statusArea.classList.add('hidden');
            }
        }

        async function generateSuggestions(code) {
            const system = `Analyze HTML code and return 3 concise improvement suggestions in JSON: { "suggestions": [string, string, string] }`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Code to analyze: ${code}` }] }],
                        systemInstruction: { parts: [{ text: system }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await res.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                updateSuggestions(result.suggestions);
            } catch (e) {}
        }

        function updateSuggestions(suggestions) {
            const list = document.getElementById('suggestions-list');
            list.innerHTML = "";
            suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = "suggestion-chip text-xs bg-slate-800/60 p-3 rounded-xl text-slate-300 hover:text-sky-400 flex items-start gap-2 border border-slate-700";
                div.innerHTML = `<span class="text-sky-500">âœ¦</span> <span>${s}</span>`;
                div.onclick = () => {
                    const current = document.getElementById('edit-prompt').value;
                    document.getElementById('edit-prompt').value = current ? `${current}\n${s}` : s;
                    document.getElementById('edit-prompt').focus();
                };
                list.appendChild(div);
            });
        }

        function copyCode() {
            const el = document.createElement('textarea');
            el.value = currentCode;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }

        document.getElementById('download-btn').onclick = () => {
            let fileName = document.getElementById('project-name').value.trim();
            if (!fileName) {
                const date = new Date().toISOString().split('T')[0];
                fileName = `cartridge_${date}`;
            }
            if (!fileName.toLowerCase().endsWith('.html')) fileName += '.html';

            const blob = new Blob([currentCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; 
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>