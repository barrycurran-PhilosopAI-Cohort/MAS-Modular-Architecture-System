<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Cloud Cartridge Suite V2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Fira+Code&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f1f5f9; margin: 0; overflow: hidden; height: 100vh; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .code-font { font-family: 'Fira Code', monospace; }
        .spinner { border: 3px solid rgba(56, 189, 248, 0.1); border-top: 3px solid #38bdf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col">

    <!-- FORCED AUTH OVERLAY (NO STORAGE) -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950">
        <div class="w-full max-w-md p-8 glass rounded-2xl border border-sky-500/30 shadow-2xl">
            <h2 class="text-xl font-bold mb-1 text-sky-400 uppercase tracking-tighter">System Initialization</h2>
            <p class="text-[10px] text-slate-500 mb-6 uppercase tracking-widest">Authentication Required for Every Session</p>
            
            <input type="password" id="api-key-input" placeholder="GEMINI_API_KEY" 
                   class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-4 text-sm text-sky-400 outline-none focus:border-sky-500 mb-4 code-font">
            
            <button onclick="unlock()" class="w-full py-4 bg-sky-600 hover:bg-sky-500 rounded-xl font-bold text-xs tracking-widest uppercase transition-all">
                Access Suite
            </button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-14 border-b border-slate-800 glass flex justify-between items-center px-6 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-6 h-6 bg-sky-600 rounded flex items-center justify-center font-bold text-[10px]">C2</div>
            <h1 class="text-[10px] font-bold uppercase tracking-widest">Cartridge Suite <span class="text-sky-500">2.0</span></h1>
        </div>
        <button onclick="downloadCode()" id="dl-btn" class="hidden px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 rounded text-[10px] font-bold uppercase">Save App</button>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- CONTROL PANEL -->
        <aside class="w-[400px] border-r border-slate-800 bg-slate-950 flex flex-col p-6 space-y-6 overflow-y-auto">
            <div id="setup-fields" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Project Name</label>
                    <input type="text" id="proj-name" placeholder="my-awesome-app" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-4 py-2 text-sm outline-none focus:border-sky-500">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Requirements</label>
                    <textarea id="prompt" placeholder="Describe your app..." class="w-full h-40 bg-slate-900 border border-slate-800 rounded-xl p-4 text-sm outline-none focus:border-sky-500"></textarea>
                </div>
            </div>

            <div id="refine-fields" class="hidden space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-sky-500 uppercase">AI Suggestions</label>
                    <div id="suggestions" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Changes Needed</label>
                    <textarea id="edit-prompt" placeholder="Refine the UI or add features..." class="w-full h-32 bg-slate-900 border border-slate-800 rounded-xl p-4 text-sm outline-none focus:border-sky-500"></textarea>
                </div>
            </div>

            <div id="loader" class="hidden flex items-center gap-3 p-4 bg-sky-500/5 border border-sky-500/20 rounded-xl">
                <div class="spinner"></div>
                <span class="text-[10px] font-bold text-sky-400 uppercase tracking-widest">Compiling...</span>
            </div>

            <p id="err-msg" class="hidden p-3 bg-red-900/20 border border-red-500/30 text-red-400 text-[10px] rounded-lg"></p>

            <button onclick="generate()" id="main-btn" class="w-full py-4 bg-sky-600 hover:bg-sky-500 rounded-xl font-bold text-xs tracking-widest uppercase transition-all shrink-0">
                Run Build
            </button>
        </aside>

        <!-- PREVIEW AREA -->
        <section class="flex-1 bg-black relative">
            <div id="empty" class="absolute inset-0 flex items-center justify-center text-slate-800">
                <p class="text-[10px] uppercase tracking-[0.4em] font-bold">Waiting for deployment...</p>
            </div>
            <iframe id="viewer" class="w-full h-full border-none hidden"></iframe>
        </section>
    </main>

    <script>
        let key = "";
        let code = "";
        let mode = "create";

        function unlock() {
            const input = document.getElementById('api-key-input').value.trim();
            if(input) { key = input; document.getElementById('auth-overlay').style.display = 'none'; }
        }

        async function generate() {
            const msg = mode === "create" ? document.getElementById('prompt').value : document.getElementById('edit-prompt').value;
            if(!msg) return;

            const btn = document.getElementById('main-btn');
            const loader = document.getElementById('loader');
            const err = document.getElementById('err-msg');
            
            btn.disabled = true;
            loader.classList.remove('hidden');
            err.classList.add('hidden');

            const MODEL = "gemini-2.5-flash-preview-09-2025";
            const URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`;

            const sys = `Output ONLY JSON: {"code": "full_html_string", "suggestions": ["string"]}. Use Tailwind CSS. Single HTML file.`;
            const userText = mode === "create" ? msg : `Update this code: ${msg}\n\nCode: ${code}`;

            try {
                const res = await fetch(URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userText }] }],
                        systemInstruction: { parts: [{ text: sys }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await res.json();
                if(data.error) throw new Error(data.error.message);

                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                code = result.code;

                const viewer = document.getElementById('viewer');
                viewer.srcdoc = code;
                viewer.classList.remove('hidden');
                document.getElementById('empty').classList.add('hidden');
                document.getElementById('dl-btn').classList.remove('hidden');

                if(mode === "create") {
                    mode = "edit";
                    document.getElementById('setup-fields').classList.add('hidden');
                    document.getElementById('refine-fields').classList.remove('hidden');
                    btn.innerText = "Apply Updates";
                }

                const sugBox = document.getElementById('suggestions');
                sugBox.innerHTML = "";
                result.suggestions.forEach(s => {
                    const b = document.createElement('button');
                    b.className = "px-3 py-1 bg-slate-900 border border-slate-800 rounded text-[9px] text-slate-400 hover:border-sky-500";
                    b.innerText = s;
                    b.onclick = () => { document.getElementById('edit-prompt').value = s; };
                    sugBox.appendChild(b);
                });

            } catch (e) {
                err.innerText = `Error: ${e.message}`;
                err.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        function downloadCode() {
            const blob = new Blob([code], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (document.getElementById('proj-name').value || 'app') + ".html";
            a.click();
        }
    </script>
</body>
</html>