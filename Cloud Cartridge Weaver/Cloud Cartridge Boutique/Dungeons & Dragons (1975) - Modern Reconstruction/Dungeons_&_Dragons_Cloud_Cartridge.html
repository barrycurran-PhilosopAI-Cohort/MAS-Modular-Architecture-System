<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Retro Crawler - Cloud Cartridge Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=MedievalSharp&display=swap');
        
        body {
            background-color: #1a1a1a;
            color: #d4af37;
            font-family: 'MedievalSharp', cursive;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #terminal {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: #000;
            border: 3px double #d4af37;
            margin: 10px;
        }

        .visual-frame {
            height: 250px;
            background: #000;
            border-bottom: 2px solid #d4af37;
            position: relative;
        }

        #scene-image {
            width: 100%; height: 100%; object-fit: cover; opacity: 0.5;
        }

        #input-area {
            padding: 15px;
            background: #2b2b2b;
            border-top: 2px solid #d4af37;
            display: flex;
        }

        input {
            background: transparent; border: none; color: #fff;
            outline: none; width: 100%; font-size: 1.2rem;
            margin-left: 10px;
        }

        .stats-panel {
            background: #d4af37; color: #000;
            padding: 5px 15px; display: flex; justify-content: space-between;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="stats-panel">
        <span>HP: <span id="hp">20</span>/20</span>
        <span>LEVEL: 1 FIGHTER</span>
        <span>GP: <span id="gp">0</span></span>
    </div>

    <div class="visual-frame">
        <img id="scene-image" src="" alt="Dungeon Scene">
    </div>

    <div id="terminal">
        <h1 class="text-2xl text-center mb-4" style="font-family: 'Cinzel';">DUNGEONS & DRAGONS</h1>
        <p class="text-center text-xs opacity-60 mb-4">RECONSTRUCTED VIA CLOUD CARTRIDGE WEAVER</p>
        <div id="history"></div>
    </div>

    <div id="input-area">
        <span class="font-bold">></span>
        <input type="text" id="user-input" autofocus placeholder="Commands: GO NORTH, ATTACK, SEARCH, LOOK">
    </div>

    <script>
        const apiKey = "";
        const history = document.getElementById('history');
        const input = document.getElementById('user-input');

        const state = {
            hp: 20,
            maxHp: 20,
            gp: 0,
            loc: "ENTRANCE",
            inCombat: false,
            monster: null
        };

        const rooms = {
            "ENTRANCE": {
                name: "Dungeon Entrance",
                desc: "Dark stone walls drip with moisture. A heavy iron door leads North.",
                exits: { "NORTH": "HALLWAY" },
                prompt: "A dark dungeon entrance, stone walls, flickering torches, oil painting style."
            },
            "HALLWAY": {
                name: "The Long Hall",
                desc: "A long corridor stretches into the darkness. Bones crunch under your feet.",
                exits: { "SOUTH": "ENTRANCE", "NORTH": "CHAMBER" },
                prompt: "A dark dungeon hallway with skeletons on the floor, fantasy art style."
            },
            "CHAMBER": {
                name: "The Crypt",
                desc: "A vast room with a stone sarcophagus. An Orc stands guard!",
                exits: { "SOUTH": "HALLWAY" },
                monster: { name: "Orc", hp: 12, attack: 4 },
                prompt: "A fantasy crypt with a stone tomb and an orc warrior, dramatic lighting."
            }
        };

        function print(msg, color = "text-yellow-200") {
            const d = document.createElement('div');
            d.className = `mb-1 ${color}`;
            d.innerText = msg;
            history.appendChild(d);
            document.getElementById('terminal').scrollTop = document.getElementById('terminal').scrollHeight;
        }

        async function updateVisual() {
            if (!apiKey) return;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    body: JSON.stringify({ instances: [{ prompt: rooms[state.loc].prompt }] })
                });
                const data = await res.json();
                if (data.predictions?.[0]) {
                    document.getElementById('scene-image').src = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                }
            } catch (e) {}
        }

        function look() {
            const r = rooms[state.loc];
            print(`--- ${r.name} ---`, "text-yellow-500 font-bold");
            print(r.desc);
            if (r.monster && r.monster.hp > 0) {
                print(`A hostile ${r.monster.name} attacks!`, "text-red-500");
                state.inCombat = true;
                state.monster = { ...r.monster };
            }
            updateVisual();
        }

        function handleInput(raw) {
            const cmd = raw.toUpperCase().split(' ');
            const verb = cmd[0];
            const noun = cmd[1] || "";

            if (state.inCombat && verb !== "ATTACK") {
                print("You cannot do that while in combat! ATTACK!");
                return;
            }

            if (verb === "GO" || ["NORTH", "SOUTH", "EAST", "WEST"].includes(verb)) {
                const dir = ["NORTH", "SOUTH", "EAST", "WEST"].includes(verb) ? verb : noun;
                const next = rooms[state.loc].exits[dir];
                if (next) { state.loc = next; look(); }
                else print("You hit a wall.");
            } else if (verb === "ATTACK") {
                if (!state.inCombat) {
                    print("You swing at the air. It feels silly.");
                    return;
                }
                const dmg = Math.floor(Math.random() * 8) + 2;
                state.monster.hp -= dmg;
                print(`You hit the ${state.monster.name} for ${dmg} damage!`);
                
                if (state.monster.hp <= 0) {
                    print(`The ${state.monster.name} falls! You find 50 gold.`);
                    state.gp += 50;
                    document.getElementById('gp').innerText = state.gp;
                    state.inCombat = false;
                    rooms[state.loc].monster.hp = 0; // Clear room
                } else {
                    const mDmg = Math.floor(Math.random() * state.monster.attack) + 1;
                    state.hp -= mDmg;
                    document.getElementById('hp').innerText = state.hp;
                    print(`The ${state.monster.name} hits you for ${mDmg} damage!`);
                    if (state.hp <= 0) print("YOU HAVE DIED. REFRESH TO RESTART.", "text-red-600 font-bold");
                }
            } else if (verb === "LOOK") {
                look();
            } else {
                print("I don't know how to " + verb);
            }
        }

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const val = input.value.trim();
                if (val) handleInput(val);
                input.value = "";
            }
        });

        window.onload = () => {
            print("Welcome, Brave Adventurer...");
            look();
        };
    </script>
</body>
</html>