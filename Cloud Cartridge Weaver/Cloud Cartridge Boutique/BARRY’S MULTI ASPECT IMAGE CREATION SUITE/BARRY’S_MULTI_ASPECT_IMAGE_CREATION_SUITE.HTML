<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barry's Multi-Aspect Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        .drag-drop-area { border: 3px dashed #6366f1; background-color: #1e293b; transition: all 0.3s; }
        .drag-drop-area.highlight { border-color: #4ade80; background-color: #0f172a; }
        .loading-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .preview-container { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            margin: auto; 
            background: #000; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .workspace-min-height { min-height: 450px; }
        .btn-section { border-top: 1px solid #334155; padding-top: 1rem; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-5xl mx-auto space-y-6">
        <header class="text-center py-6 rounded-2xl bg-gradient-to-r from-indigo-600 to-emerald-700 shadow-xl">
            <h1 class="text-4xl font-extrabold tracking-tight">Barry's Garden Image Suite</h1>
            <p class="text-indigo-100 mt-2">Convert, Create, and Edit with Widescreen & Vertical Logic</p>
        </header>

        <section class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
            <div id="imageDisplayContainer" class="preview-container workspace-min-height mb-6">
                <div id="dropZone" class="drag-drop-area absolute inset-0 flex flex-col items-center justify-center p-4 cursor-pointer text-slate-400 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-xl font-bold text-white">Drop Image to Convert or Edit</p>
                    <p class="text-sm italic">Or just type below to generate from scratch</p>
                </div>
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <img id="generatedImage" src="" alt="Output" class="max-w-full max-h-full object-contain hidden">
                
                <div id="loadingIndicator" class="absolute inset-0 bg-black/70 flex flex-col items-center justify-center hidden z-50">
                    <svg class="animate-spin h-12 w-12 text-indigo-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p id="loadingText" class="text-indigo-300 font-bold animate-pulse uppercase">PROCESSING...</p>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2 uppercase tracking-wider text-center">Image Description / Instructions</label>
                    <textarea id="promptInput" rows="2" class="w-full p-4 bg-slate-900 border border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 text-white placeholder-slate-500" placeholder="Type here to CREATE a new image OR describe EDITS for an uploaded photo..."></textarea>
                </div>
                
                <!-- NEW SECTION: GENERATION -->
                <div class="btn-section">
                    <p class="text-center text-xs text-slate-500 mb-3 uppercase font-bold tracking-widest">1. Create New from Description</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="genWidescreenBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all active:scale-95">
                            CREATE 16:9 WIDESCREEN<br>
                            <span class="text-[10px] font-normal opacity-80">(From Description Above)</span>
                        </button>
                        <button id="genVerticalBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all active:scale-95">
                            CREATE 9:16 VERTICAL<br>
                            <span class="text-[10px] font-normal opacity-80">(From Description Above)</span>
                        </button>
                    </div>
                </div>

                <!-- EXISTING SECTION: CONVERSION (RENAMED AS REQUESTED) -->
                <div class="btn-section">
                    <p class="text-center text-xs text-slate-500 mb-3 uppercase font-bold tracking-widest">2. Convert Uploaded Image</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="toWidescreenBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all active:scale-95 disabled:opacity-50">
                            CONVERT TO 16:9 WIDESCREEN<br>
                            <span class="text-[10px] font-normal opacity-80">(For Large TVs & Monitors)</span>
                        </button>
                        <button id="toVerticalBtn" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all active:scale-95 disabled:opacity-50">
                            CONVERT TO 9:16 VERTICAL<br>
                            <span class="text-[10px] font-normal opacity-80">(For Cell Phones & Reels)</span>
                        </button>
                    </div>
                </div>

                <!-- NEW SECTION: EDITING -->
                <div class="btn-section">
                    <p class="text-center text-xs text-slate-500 mb-3 uppercase font-bold tracking-widest">3. Edit Uploaded Image</p>
                    <button id="editImageBtn" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all active:scale-95 disabled:opacity-50">
                        IMAGE TO IMAGE EDITING<br>
                        <span class="text-[10px] font-normal opacity-80">(Modify current photo using description)</span>
                    </button>
                </div>
            </div>

            <div id="actionButtons" class="mt-8 flex justify-center space-x-4 hidden">
                <button id="downloadBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-8 py-2 rounded-lg font-bold">Download Result</button>
                <button id="clearBtn" class="bg-red-600 hover:bg-red-500 text-white px-8 py-2 rounded-lg font-bold">Clear / Reset</button>
            </div>
            
            <p id="statusMsg" class="mt-4 text-center text-slate-400 text-sm italic"></p>
        </section>
    </div>

    <script>
        const apiKey = "";
        const IMAGEN_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
        const FLASH_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

        const dropZone = document.getElementById('dropZone');
        const imageInput = document.getElementById('imageInput');
        const genImage = document.getElementById('generatedImage');
        const promptInput = document.getElementById('promptInput');
        const statusMsg = document.getElementById('statusMsg');
        const loader = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');
        const actionButtons = document.getElementById('actionButtons');

        let base64 = null;

        // TASK 1: Create New Image (Imagen)
        async function generateNew(aspect) {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                statusMsg.textContent = "Please write a description first.";
                return;
            }
            
            loader.classList.remove('hidden');
            loadingText.textContent = `GENERATING NEW ${aspect} IMAGE...`;

            let aspectInstruction = aspect === "16:9" 
                ? "This image must be a 16:9 horizontal rectangle for a large screen TV. Add thick black letterbox bars at the top and bottom."
                : "This image must be a 9:16 vertical rectangle for a cell phone. Add thick black pillarbox bars on the left and right sides.";

            try {
                const res = await fetch(IMAGEN_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instances: [{ prompt: `${aspectInstruction} Subject: ${userPrompt}` }],
                        parameters: { sampleCount: 1 }
                    })
                });
                const data = await res.json();
                const imgData = data.predictions[0].bytesBase64Encoded;
                
                genImage.src = `data:image/png;base64,${imgData}`;
                genImage.classList.remove('hidden');
                dropZone.classList.add('hidden');
                actionButtons.classList.remove('hidden');
                statusMsg.textContent = `New ${aspect} image created.`;
            } catch (e) {
                statusMsg.textContent = "Generation failed. Try a simpler prompt.";
            }
            loader.classList.add('hidden');
        }

        // TASK 2: Convert or Edit Existing (Flash)
        async function processExisting(mode) {
            if (!base64) {
                statusMsg.textContent = "Drop an image first.";
                return;
            }
            loader.classList.remove('hidden');
            
            let instruction = "";
            const userPrompt = promptInput.value || "Make it look natural.";
            
            if (mode === "16:9") {
                loadingText.textContent = "CONVERTING TO WIDESCREEN...";
                instruction = `MANDATORY: Transform this image into a 16:9 aspect ratio horizontal rectangle for a large TV. 
                FORCE THE FORMAT: Add thick black letterbox bars horizontally across the absolute top and bottom. 
                Expand the environment horizontally to fill the frame while keeping center content.`;
            } else if (mode === "9:16") {
                loadingText.textContent = "CONVERTING TO VERTICAL...";
                instruction = `MANDATORY: Transform this image into a 9:16 aspect ratio vertical rectangle for a cell phone. 
                FORCE THE FORMAT: Add thick black pillarbox bars vertically on the left and right. 
                Expand the environment vertically to fill the tall frame while keeping center content.`;
            } else if (mode === "edit") {
                loadingText.textContent = "EDITING IMAGE...";
                instruction = `MANDATORY: Modify the current image based on the user's description. Keep the existing composition but apply these changes: ${userPrompt}`;
            }

            try {
                const res = await fetch(FLASH_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: instruction + "\nDescription: " + userPrompt },
                                { inlineData: { mimeType: "image/png", data: base64 } }
                            ]
                        }],
                        generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
                    })
                });

                const data = await res.json();
                const outBase64 = data?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (outBase64) {
                    genImage.src = `data:image/png;base64,${outBase64}`;
                    genImage.classList.remove('hidden');
                    dropZone.classList.add('hidden');
                    actionButtons.classList.remove('hidden');
                    statusMsg.textContent = mode === "edit" ? "Edit applied." : "Conversion complete.";
                }
            } catch (e) {
                statusMsg.textContent = "Failed to process image.";
            }
            loader.classList.add('hidden');
        }

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                base64 = e.target.result.split(',')[1];
                genImage.src = e.target.result;
                genImage.classList.remove('hidden');
                dropZone.classList.add('hidden');
                actionButtons.classList.remove('hidden');
                statusMsg.textContent = "Image loaded. Choose to Convert or Edit.";
            };
            reader.readAsDataURL(file);
        }

        dropZone.onclick = () => imageInput.click();
        imageInput.onchange = (e) => handleFile(e.target.files[0]);

        // Mappings
        document.getElementById('genWidescreenBtn').onclick = () => generateNew("16:9");
        document.getElementById('genVerticalBtn').onclick = () => generateNew("9:16");
        document.getElementById('toWidescreenBtn').onclick = () => processExisting("16:9");
        document.getElementById('toVerticalBtn').onclick = () => processExisting("9:16");
        document.getElementById('editImageBtn').onclick = () => processExisting("edit");

        document.getElementById('clearBtn').onclick = () => location.reload();
        document.getElementById('downloadBtn').onclick = () => {
            const a = document.createElement('a');
            a.href = genImage.src;
            a.download = "barry_garden_asset.png";
            a.click();
        };

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => {
            dropZone.addEventListener(eName, (e) => { e.preventDefault(); e.stopPropagation(); });
        });
        dropZone.addEventListener('dragover', () => dropZone.classList.add('highlight'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('highlight'));
        dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('highlight');
            handleFile(e.dataTransfer.files[0]);
        });
    </script>
</body>
</html>