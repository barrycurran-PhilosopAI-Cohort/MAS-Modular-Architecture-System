<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocalist Pro Elite: Global Edition - Universal Translation & TTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e5e5; min-height: 100vh; }
        .glass-panel { background: rgba(23, 23, 23, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(to right, #60a5fa, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-primary { background: linear-gradient(to bottom right, #3b82f6, #8b5cf6); transition: all 0.3s ease; }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-primary:disabled { background: #404040; cursor: not-allowed; opacity: 0.7; }
        
        .chunk-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; }
        .chunk-card.active-edit { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .chunk-card.completed { border-color: rgba(34, 197, 94, 0.2); }
        
        .loader { border: 2px solid rgba(255,255,255,0.2); border-top: 2px solid #fff; border-radius: 50%; width: 14px; height: 14px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .error-toast { background: #ef4444; color: white; padding: 12px 24px; border-radius: 12px; position: fixed; bottom: 20px; right: 20px; z-index: 50; display: none; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(100px); } to { transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center">

    <div id="errorToast" class="error-toast font-bold text-xs uppercase tracking-widest shadow-2xl"></div>

    <div class="max-w-6xl w-full space-y-6">
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 text-center md:text-left">
            <div>
                <h1 class="text-4xl font-extrabold tracking-tight gradient-text leading-none uppercase">Vocalist Pro Elite</h1>
                <p class="text-neutral-500 text-[10px] font-bold tracking-[0.2em] uppercase mt-1">Global Edition • Universal Translation • v2.6.1</p>
            </div>
            <div id="statusContainer" class="hidden glass-panel px-6 py-3 rounded-2xl flex items-center gap-4">
                <span id="statusText" class="text-[10px] font-bold text-blue-400 uppercase tracking-tighter">Ready</span>
                <div class="w-32 bg-neutral-800 rounded-full h-1 overflow-hidden">
                    <div id="progressBar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-4">
                <div id="dropZone" class="glass-panel rounded-3xl p-6 space-y-4 relative overflow-hidden border border-white/10">
                    <div id="editBadge" class="hidden absolute top-0 right-0 bg-blue-600 text-white text-[9px] font-black px-4 py-1 rounded-bl-xl uppercase tracking-widest animate-pulse">
                        Segment Edit Mode
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-end pb-1">
                            <label id="editorLabel" class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Global Workspace</label>
                            <div class="flex items-center gap-3">
                                <span id="charCount" class="text-[10px] text-neutral-600 font-mono">0 chars</span>
                                <button id="resetBtn" title="Reset Workspace" class="flex items-center gap-1.5 px-2 py-0.5 rounded-lg border border-white/5 bg-white/5 hover:bg-red-500/10 hover:border-red-500/30 transition-all group">
                                    <span class="text-[9px] font-bold text-neutral-600 group-hover:text-red-500 uppercase tracking-tighter">Reset</span>
                                </button>
                            </div>
                        </div>
                        <textarea id="textInput" 
                            placeholder="Paste your script or drop a .txt file..."
                            class="w-full h-[380px] bg-neutral-900/50 border border-neutral-800 rounded-2xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all resize-none"></textarea>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="space-y-1">
                                <label class="text-[9px] font-bold text-neutral-600 uppercase ml-1">Target Language</label>
                                <select id="langSelect" class="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-2 text-xs focus:outline-none focus:border-blue-500">
                                    <option value="English" data-code="en" selected>English</option>
                                    <option value="Spanish" data-code="es">Spanish</option>
                                    <option value="French" data-code="fr">French</option>
                                    <option value="German" data-code="de">German</option>
                                    <option value="Italian" data-code="it">Italian</option>
                                    <option value="Japanese" data-code="ja">Japanese</option>
                                    <option value="Portuguese" data-code="pt">Portuguese</option>
                                    <option value="Chinese" data-code="zh">Chinese</option>
                                    <option value="Korean" data-code="ko">Korean</option>
                                    <option value="Russian" data-code="ru">Russian</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[9px] font-bold text-neutral-600 uppercase ml-1">Native Voice</label>
                                <select id="voiceSelect" class="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-2 text-xs focus:outline-none focus:border-blue-500">
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 px-1">
                            <input type="checkbox" id="autoTranslate" checked class="w-4 h-4 rounded border-neutral-800 bg-neutral-900 text-blue-500">
                            <label for="autoTranslate" class="text-[10px] font-bold text-neutral-400 uppercase tracking-tighter cursor-pointer">Auto-Detect & Translate</label>
                        </div>

                        <button id="prepareBtn" class="w-full h-12 rounded-xl bg-white/5 border border-white/10 font-bold text-[10px] uppercase hover:bg-white/10 flex items-center justify-center gap-2">
                            <span id="prepareText">Initialize Production</span>
                            <div id="prepareLoader" class="loader hidden"></div>
                        </button>
                    </div>

                    <div id="editActions" class="hidden space-y-2 pt-2 border-t border-white/5">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="cancelEditBtn" class="h-12 rounded-xl bg-neutral-800 text-neutral-400 font-bold text-[10px] uppercase">Cancel</button>
                            <button id="saveEditBtn" class="h-12 rounded-xl bg-blue-600 text-white font-bold text-[10px] uppercase">Update</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 flex flex-col h-full gap-6">
                <div id="chunkList" class="flex-grow space-y-3 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar border-b border-white/5 pb-4">
                    <div class="flex flex-col items-center justify-center py-40 text-neutral-600 border-2 border-dashed border-neutral-800 rounded-3xl">
                        <p class="text-sm font-medium italic">Workspace Ready...</p>
                    </div>
                </div>

                <div id="batchActionArea" class="hidden flex flex-col md:flex-row gap-4">
                    <button id="batchBtn" disabled class="btn-primary flex-grow h-14 rounded-2xl font-black text-xs uppercase tracking-widest disabled:opacity-30">
                        Synthesize Global Master
                    </button>
                    <button id="reconstructBtn" class="px-6 rounded-2xl border border-white/10 text-neutral-400 font-bold text-[9px] uppercase hover:bg-white/5 flex items-center gap-2">
                        Sync Global Editor
                    </button>
                </div>

                <div id="masterOutput" class="hidden glass-panel rounded-3xl p-6 space-y-4 border-blue-500/30">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Global Master Out</span>
                            <p class="text-[9px] text-neutral-500 mt-0.5">High-fidelity stitched multinational WAV export</p>
                        </div>
                        <button id="stitchBtn" class="bg-blue-600 text-white px-8 py-3 rounded-full text-[10px] font-black uppercase hover:scale-105 transition-transform">Stitch Master Mix</button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 items-center border-t border-white/5 pt-4">
                        <audio id="audioPlayer" controls class="w-full h-10"></audio>
                        <button id="downloadBtn" class="w-full md:w-64 h-10 rounded-xl bg-white/5 border border-white/5 text-[10px] font-bold uppercase hover:bg-white/10">Download</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let segments = []; 
        let currentEditIndex = null;
        let isBatching = false;
        let isTranslating = false;
        let masterBlob = null;
        const apiKey = ""; 

        const voiceData = {
            en: [{ id: "Iapetus", label: "Iapetus (Deep)" }, { id: "Zephyr", label: "Zephyr (Modern)" }, { id: "Kore", label: "Kore (Smooth)" }, { id: "Aoede", label: "Aoede (Clear)" }],
            es: [{ id: "Puck", label: "Puck (Energetic)" }, { id: "Charon", label: "Charon (Narrative)" }],
            fr: [{ id: "Fenrir", label: "Fenrir (Boutique)" }, { id: "Leda", label: "Leda (Elegant)" }],
            de: [{ id: "Orus", label: "Orus (Commanding)" }, { id: "Callirrhoe", label: "Callirrhoe (Precise)" }],
            it: [{ id: "Autonoe", label: "Autonoe (Warm)" }, { id: "Enceladus", label: "Enceladus (Classic)" }],
            ja: [{ id: "Umbriel", label: "Umbriel (Soft)" }, { id: "Algieba", label: "Algieba (Studio)" }],
            pt: [{ id: "Despina", label: "Despina (Brazilian)" }, { id: "Erinome", label: "Erinome (Natural)" }],
            zh: [{ id: "Algenib", label: "Algenib (Mandarin)" }, { id: "Rasalgethi", label: "Rasalgethi (Modern)" }],
            ko: [{ id: "Laomedeia", label: "Laomedeia (Smooth)" }, { id: "Achernar", label: "Achernar (Clear)" }],
            ru: [{ id: "Alnilam", label: "Alnilam (Formal)" }, { id: "Schedar", label: "Schedar (Warm)" }]
        };

        const ui = {
            input: document.getElementById('textInput'),
            lang: document.getElementById('langSelect'),
            voice: document.getElementById('voiceSelect'),
            autoTranslate: document.getElementById('autoTranslate'),
            prepare: document.getElementById('prepareBtn'),
            prepareText: document.getElementById('prepareText'),
            prepareLoader: document.getElementById('prepareLoader'),
            chunkList: document.getElementById('chunkList'),
            batchBtn: document.getElementById('batchBtn'),
            batchActionArea: document.getElementById('batchActionArea'),
            stitchBtn: document.getElementById('stitchBtn'),
            status: document.getElementById('statusContainer'),
            statusText: document.getElementById('statusText'),
            progressBar: document.getElementById('progressBar'),
            audioPlayer: document.getElementById('audioPlayer'),
            downloadBtn: document.getElementById('downloadBtn'),
            masterOutput: document.getElementById('masterOutput'),
            charCount: document.getElementById('charCount'),
            editBadge: document.getElementById('editBadge'),
            editActions: document.getElementById('editActions'),
            cancelEdit: document.getElementById('cancelEditBtn'),
            saveEdit: document.getElementById('saveEditBtn'),
            resetBtn: document.getElementById('resetBtn'),
            reconstructBtn: document.getElementById('reconstructBtn'),
            toast: document.getElementById('errorToast')
        };

        function showError(msg) {
            ui.toast.innerText = msg;
            ui.toast.style.display = 'block';
            setTimeout(() => { ui.toast.style.display = 'none'; }, 4000);
        }

        function updateVoiceList() {
            const langCode = ui.lang.options[ui.lang.selectedIndex].getAttribute('data-code');
            const voices = voiceData[langCode];
            ui.voice.innerHTML = voices.map(v => `<option value="${v.id}">${v.label}</option>`).join('');
        }
        ui.lang.addEventListener('change', updateVoiceList);
        updateVoiceList(); 

        ui.input.addEventListener('input', () => { ui.charCount.innerText = `${ui.input.value.length} chars`; });

        async function apiRequest(text, systemPrompt, attempt = 1) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (err) {
                if (attempt < 3) {
                    await new Promise(r => setTimeout(r, 1000 * attempt));
                    return apiRequest(text, systemPrompt, attempt + 1);
                }
                throw err;
            }
        }

        ui.prepare.addEventListener('click', async () => {
            let text = ui.input.value.trim();
            if (!text || isTranslating) return;
            
            if (ui.autoTranslate.checked) {
                isTranslating = true;
                ui.prepareText.innerText = "Global Translation...";
                ui.prepareLoader.classList.remove('hidden');
                ui.prepare.disabled = true;
                try {
                    const prompt = `Translate this to ${ui.lang.value}. Preserve structure. Output text ONLY.`;
                    text = await apiRequest(text, prompt);
                    ui.input.value = text;
                } catch (e) { showError("Translation Timeout. Try again."); }
                isTranslating = false;
                ui.prepareText.innerText = "Initialize Production";
                ui.prepareLoader.classList.add('hidden');
                ui.prepare.disabled = false;
            }

            segments = [];
            const TARGET_SIZE = 2000;
            let i = 0;
            while (i < text.length) {
                let end = i + TARGET_SIZE;
                if (end < text.length) {
                    const window = text.substring(end, end + 800);
                    const match = window.match(/[.!?](\s|\n|$)/);
                    if (match) end = end + match.index + 1;
                    else {
                        const lastSpace = text.lastIndexOf(' ', end + 200);
                        if (lastSpace > i) end = lastSpace;
                    }
                }
                const chunk = text.substring(i, end).trim();
                if (chunk) segments.push({ text: chunk, pcm: null });
                i = end;
            }
            renderSegments();
            ui.batchActionArea.classList.remove('hidden');
            ui.masterOutput.classList.remove('hidden');
            ui.status.classList.remove('hidden');
            ui.batchBtn.disabled = false;
        });

        function renderSegments() {
            ui.chunkList.innerHTML = '';
            if (segments.length === 0) {
                ui.chunkList.innerHTML = `<div class="py-40 text-center opacity-20 italic">No segments...</div>`;
                return;
            }
            segments.forEach((seg, idx) => {
                const card = document.createElement('div');
                card.className = `chunk-card p-5 rounded-2xl flex flex-col md:flex-row items-center gap-4 ${seg.pcm ? 'completed' : ''} ${currentEditIndex === idx ? 'active-edit' : ''}`;
                card.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <span class="text-[9px] font-black text-neutral-600 uppercase">Seg ${idx + 1}</span>
                        <p class="text-xs text-neutral-400 mt-1 truncate">${seg.text}</p>
                    </div>
                    <div class="flex gap-2">
                        ${seg.pcm ? `<button onclick="playSegment(${idx})" class="text-[10px] font-bold text-green-400 bg-green-500/10 px-4 py-2 rounded-xl">Play</button>` : 
                        `<button id="s-${idx}" onclick="processSingle(${idx})" class="text-[10px] font-bold text-blue-400 bg-blue-500/10 px-4 py-2 rounded-xl">Synth</button>`}
                        <button onclick="enterEdit(${idx})" class="text-[10px] font-bold text-neutral-500 bg-white/5 px-4 py-2 rounded-xl">Edit</button>
                    </div>`;
                ui.chunkList.appendChild(card);
            });
        }

        window.enterEdit = (idx) => {
            currentEditIndex = idx;
            ui.input.value = segments[idx].text;
            ui.editBadge.classList.remove('hidden');
            ui.editActions.classList.remove('hidden');
            ui.prepare.disabled = true;
            renderSegments();
        };

        ui.cancelEdit.addEventListener('click', exitEdit);
        ui.saveEdit.addEventListener('click', () => {
            if (currentEditIndex === null) return;
            segments[currentEditIndex].text = ui.input.value;
            segments[currentEditIndex].pcm = null;
            exitEdit();
            renderSegments();
        });

        function exitEdit() {
            currentEditIndex = null; ui.input.value = "";
            ui.editBadge.classList.add('hidden'); ui.editActions.classList.add('hidden');
            ui.prepare.disabled = false; renderSegments();
        }

        async function fetchAudio(text, voice) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                    }
                })
            });
            const result = await response.json();
            const b64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
            const binary = atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return bytes;
        }

        window.processSingle = async (idx) => {
            const btn = document.getElementById(`s-${idx}`);
            if (btn) btn.innerHTML = `<div class="loader"></div>`;
            try {
                segments[idx].pcm = await fetchAudio(segments[idx].text, ui.voice.value);
                renderSegments();
            } catch (e) { showError("Synthesis Error"); renderSegments(); }
        };

        ui.batchBtn.addEventListener('click', async () => {
            if (isBatching) return;
            isBatching = true; ui.batchBtn.disabled = true;
            for (let i = 0; i < segments.length; i++) {
                if (segments[i].pcm) continue;
                ui.statusText.innerText = `Mastering: ${i + 1}/${segments.length}`;
                ui.progressBar.style.width = `${((i+1)/segments.length)*100}%`;
                try {
                    segments[i].pcm = await fetchAudio(segments[i].text, ui.voice.value);
                    renderSegments();
                } catch (e) { i--; await new Promise(r => setTimeout(r, 2000)); }
            }
            ui.statusText.innerText = "Ready"; isBatching = false; ui.batchBtn.disabled = false;
        });

        ui.stitchBtn.addEventListener('click', () => {
            const active = segments.filter(s => s.pcm);
            if (!active.length) return;
            const total = active.reduce((a, b) => a + b.pcm.length, 0);
            const master = new Uint8Array(total);
            let offset = 0;
            segments.forEach(s => { if(s.pcm) { master.set(s.pcm, offset); offset += s.pcm.length; }});
            const wav = pcmToWav(master, 24000);
            masterBlob = new Blob([wav], { type: 'audio/wav' });
            ui.audioPlayer.src = URL.createObjectURL(masterBlob);
            ui.audioPlayer.play();
        });

        window.playSegment = (idx) => {
            const wav = pcmToWav(segments[idx].pcm, 24000);
            new Audio(URL.createObjectURL(new Blob([wav], { type: 'audio/wav' }))).play();
        };

        function pcmToWav(bytes, sampleRate) {
            const buffer = new ArrayBuffer(44 + bytes.length);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true);
            writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, bytes.length, true);
            new Uint8Array(buffer, 44).set(bytes); return buffer;
        }

        ui.downloadBtn.addEventListener('click', () => {
            if (!masterBlob) return;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(masterBlob);
            a.download = `VPE_MASTER_${Date.now()}.wav`; a.click();
        });

        ui.resetBtn.addEventListener('click', () => { if(confirm("Reset?")) location.reload(); });
        ui.reconstructBtn.addEventListener('click', () => { ui.input.value = segments.map(s => s.text).join('\n\n'); });
    </script>
</body>
</html>