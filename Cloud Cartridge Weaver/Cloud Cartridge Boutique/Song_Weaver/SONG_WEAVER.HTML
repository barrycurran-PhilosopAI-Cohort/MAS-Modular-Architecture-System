<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Composer Boutique: String Weaver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: #94a3b8; min-height: 100vh; font-family: sans-serif; padding: 20px; }
        .key { transition: all 0.1s; cursor: pointer; user-select: none; }
        .key:active { transform: scale(0.95); background-color: #38bdf8 !important; color: white; }
        .note-bubble { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body class="flex flex-col items-center">

<div class="max-w-4xl w-full space-y-6">
    <!-- Main Studio Console -->
    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl relative">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <div class="text-left">
                <div class="text-[10px] uppercase tracking-[0.4em] mb-1 text-sky-500 font-bold">Aero-Cart Logic Engine</div>
                <h1 class="text-3xl font-light text-white">String Weaver Studio</h1>
            </div>
            <div id="statusIndicator" class="px-4 py-1 rounded-full bg-slate-800 border border-slate-700 text-[10px] uppercase tracking-widest text-slate-400">
                Mode: Free Play
            </div>
        </div>

        <!-- 1. LIVE STREAM (What you see as you play) -->
        <div class="mb-6">
            <h3 class="text-[10px] uppercase tracking-widest text-slate-500 mb-2 font-bold">1. Live View (Play here to find your song)</h3>
            <div id="liveStream" class="bg-black/40 rounded-xl p-4 min-h-[60px] border border-slate-800 flex flex-wrap gap-2 items-center overflow-x-auto">
                <div class="text-slate-700 text-xs italic">Awaiting input...</div>
            </div>
        </div>

        <!-- 2. SAVED SEQUENCE (What you've recorded) -->
        <div class="mb-6">
            <h3 class="text-[10px] uppercase tracking-widest text-red-500/70 mb-2 font-bold flex items-center gap-2">
                2. Recorded Sequence <span id="recDot" class="hidden w-2 h-2 bg-red-500 rounded-full recording-pulse"></span>
            </h3>
            <div id="recordedRibbon" class="bg-red-950/10 rounded-xl p-4 min-h-[60px] border border-red-900/20 flex flex-wrap gap-2 items-center">
                <div id="recEmptyMsg" class="text-slate-700 text-xs italic">No notes recorded yet.</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button id="recordBtn" onclick="toggleRecording()" class="py-4 bg-slate-800 border border-slate-700 text-white rounded-2xl text-sm font-bold hover:bg-red-900/40 transition-all flex flex-col items-center justify-center">
                <span id="recLabel">Start Recording</span>
                <span class="text-[8px] opacity-50 uppercase mt-1">Capture Melodies</span>
            </button>
            <button onclick="playRecorded()" class="py-4 bg-slate-800 border border-slate-700 text-white rounded-2xl text-sm font-bold hover:bg-slate-700 transition-all flex flex-col items-center justify-center">
                <span>Play Back</span>
                <span class="text-[8px] opacity-50 uppercase mt-1">Review Recording</span>
            </button>
            <button onclick="clearEverything()" class="py-4 bg-slate-800 border border-slate-700 text-white rounded-2xl text-sm font-bold hover:bg-slate-700 transition-all flex flex-col items-center justify-center">
                <span>Clear All</span>
                <span class="text-[8px] opacity-50 uppercase mt-1">Reset Session</span>
            </button>
            <div class="flex flex-col gap-2">
                <input type="text" id="songName" placeholder="Name your song..." class="bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white text-xs focus:outline-none focus:border-sky-500 w-full">
                <button onclick="exportSong()" class="flex-1 bg-sky-600 text-white rounded-xl text-xs font-bold hover:bg-sky-500 shadow-lg shadow-sky-900/20">
                    üíæ Save Cartridge
                </button>
            </div>
        </div>
    </div>

    <!-- The Instrument -->
    <div class="grid grid-cols-4 md:grid-cols-8 gap-3">
        <button onmousedown="handleNote(261.63, 'C')" class="key bg-slate-900 p-6 rounded-2xl border border-slate-800 text-white hover:border-sky-500 aspect-square flex flex-col items-center justify-center">
            <span class="text-2xl font-bold">C</span><span class="text-[10px] opacity-40">Do</span>
        </button>
        <button onmousedown="handleNote(293.66, 'D')" class="key bg-slate-900 p-6 rounded-2xl border border-slate-800 text-white hover:border-sky-500 aspect-square flex flex-col items-center justify-center">
            <span class="text-2xl font-bold">D</span><span class="text-[10px] opacity-40">Re</span>
        </button>
        <button onmousedown="handleNote(329.63, 'E')" class="key bg-slate-900 p-6 rounded-2xl border border-slate-800 text-white hover:border-sky-500 aspect-square flex flex-col items-center justify-center">
            <span class="text-2xl font-bold">E</span><span class="text-[10px] opacity-40">Mi</span>
        </button>
        <button onmousedown="handleNote(349.23, 'F')" class="key bg-slate-900 p-6 rounded-2xl border border-slate-800 text-white hover:border-sky-500 aspect-square flex flex-col items-center justify-center">
            <span class="text-2xl font-bold">F</span><span class="text-[10px] opacity-40">Fa</span>
        </button>
        <button onmousedown="handleNote(392.00, 'G')" class="key bg-slate-900 p-6 rounded-2xl border border-slate-800 text-white hover:border-sky-500 aspect-square flex flex-col items-center justify-center">
            <span class="text-2xl font-bold">G</span><span class="text-[10px] opacity-40">Sol</span>
        </button>
        <button onmousedown="handleNote(440.00, 'A')" class="key bg-slate-900 p-6 rounded-2xl border border-slate-800 text-white hover:border-sky-500 aspect-square flex flex-col items-center justify-center">
            <span class="text-2xl font-bold">A</span><span class="text-[10px] opacity-40">La</span>
        </button>
        <button onmousedown="handleNote(493.88, 'B')" class="key bg-slate-900 p-6 rounded-2xl border border-slate-800 text-white hover:border-sky-500 aspect-square flex flex-col items-center justify-center">
            <span class="text-2xl font-bold">B</span><span class="text-[10px] opacity-40">Ti</span>
        </button>
        <button onmousedown="handleNote(523.25, 'C+')" class="key bg-slate-900 p-6 rounded-2xl border border-slate-800 text-white hover:border-sky-500 aspect-square flex flex-col items-center justify-center">
            <span class="text-2xl font-bold">C+</span><span class="text-[10px] opacity-40">Do</span>
        </button>
    </div>

    <!-- Songbook Section -->
    <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800">
        <h3 class="text-[10px] uppercase tracking-widest text-slate-500 mb-4 font-bold flex items-center gap-2">
            üìñ Practice Sheets (Follow the notes)
        </h3>
        <select onchange="document.getElementById('guide').innerText = this.value" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-sm text-slate-300 focus:outline-none">
            <option value="Select a song to see notes...">Select a Song...</option>
            <option value="C C G G A A G | F F E E D D C">Twinkle Twinkle</option>
            <option value="E E F G G F E D C C D E E D D">Ode to Joy</option>
            <option value="C F A F A G F D C">Amazing Grace</option>
        </select>
        <div id="guide" class="mt-4 text-sky-400 font-mono text-center tracking-widest text-lg">Select a song to see notes...</div>
    </div>
</div>

<script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    let isRecording = false;
    let recordedSequence = [];

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new AudioContext();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function pluck(frequency) {
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine'; 
        osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.0);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 1.0);
    }

    function handleNote(freq, noteName) {
        pluck(freq);
        
        const stream = document.getElementById('liveStream');
        if (stream.innerHTML.includes('Awaiting input')) stream.innerHTML = '';
        const bubble = document.createElement('div');
        bubble.className = "note-bubble bg-slate-800 text-sky-400 border border-sky-900/50 px-3 py-1 rounded-md font-bold text-xs shadow-inner";
        bubble.innerText = noteName;
        stream.appendChild(bubble);
        stream.scrollLeft = stream.scrollWidth;

        if (isRecording) {
            recordedSequence.push({ freq, noteName, timestamp: Date.now() });
            const recRibbon = document.getElementById('recordedRibbon');
            document.getElementById('recEmptyMsg').style.display = 'none';
            const recBubble = document.createElement('div');
            recBubble.className = "note-bubble bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-[10px] shadow-lg";
            recBubble.innerText = noteName;
            recRibbon.appendChild(recBubble);
        }
    }

    function toggleRecording() {
        initAudio();
        isRecording = !isRecording;
        const btn = document.getElementById('recordBtn');
        const dot = document.getElementById('recDot');
        const status = document.getElementById('statusIndicator');
        
        if (isRecording) {
            recordedSequence = [];
            document.getElementById('recordedRibbon').innerHTML = '<div id="recEmptyMsg" style="display:none"></div>';
            document.getElementById('recLabel').innerText = "Stop Recording";
            btn.classList.replace('bg-slate-800', 'bg-red-900/40');
            dot.classList.remove('hidden');
            status.innerText = "Mode: Recording";
            status.classList.add('text-red-400', 'border-red-900/50');
        } else {
            document.getElementById('recLabel').innerText = "Start Recording";
            btn.classList.replace('bg-red-900/40', 'bg-slate-800');
            dot.classList.add('hidden');
            status.innerText = "Mode: Free Play";
            status.classList.remove('text-red-400', 'border-red-900/50');
        }
    }

    function clearEverything() {
        recordedSequence = [];
        document.getElementById('liveStream').innerHTML = '<div class="text-slate-700 text-xs italic">Awaiting input...</div>';
        document.getElementById('recordedRibbon').innerHTML = '<div id="recEmptyMsg" class="text-slate-700 text-xs italic">No notes recorded yet.</div>';
        if (isRecording) toggleRecording();
    }

    function playRecorded() {
        if (recordedSequence.length === 0) return;
        initAudio();
        const start = recordedSequence[0].timestamp;
        recordedSequence.forEach(n => {
            setTimeout(() => pluck(n.freq), n.timestamp - start);
        });
    }

    function exportSong() {
        if (recordedSequence.length === 0) {
            alert("Record something first!");
            return;
        }
        const sName = document.getElementById('songName').value || "My Song";
        const content = `<!DOCTYPE html>
<html>
<head>
    <title>${sName}</title>
    <script src="https://cdn.tailwindcss.com"></` + `script>
    <style>
        .staff { position: relative; height: 100px; border-top: 1px solid #475569; border-bottom: 1px solid #475569; margin: 40px 0; }
        .staff::before { content: ''; position: absolute; top: 25%; left: 0; right: 0; border-top: 1px solid #475569; }
        .staff::after { content: ''; position: absolute; top: 50%; left: 0; right: 0; border-top: 1px solid #475569; }
        .staff-mid { position: absolute; top: 75%; left: 0; right: 0; border-top: 1px solid #475569; }
        .note-head { position: absolute; width: 14px; height: 10px; background: white; border-radius: 50%; transform: rotate(-20deg); transition: all 0.2s; }
        .note-stem { position: absolute; width: 1.5px; height: 35px; background: white; bottom: 5px; right: 0; }
        .playing { background: #38bdf8 !important; box-shadow: 0 0 15px #38bdf8; transform: rotate(-20deg) scale(1.3); }
        .clef { position: absolute; left: 10px; top: -10px; font-size: 60px; color: #94a3b8; font-family: serif; pointer-events: none; }
    </style>
</head>
<body class="bg-slate-900 text-white flex flex-col items-center justify-center min-h-screen p-10 font-sans">
    <div class="max-w-4xl w-full p-10 bg-slate-800 rounded-[3rem] border border-slate-700 shadow-2xl text-center">
        <h1 class="text-4xl font-bold mb-4">${sName}</h1>
        <p class="text-slate-400 text-sm mb-8 italic">Interactive Sheet Music Practice for Alicia</p>
        
        <div class="relative bg-slate-900 rounded-2xl p-8 mb-8 overflow-hidden">
            <div class="clef">ùÑû</div>
            <div class="staff">
                <div class="staff-mid"></div>
                <div id="notesContainer"></div>
            </div>
        </div>

        <button id="playBtn" onclick="play()" class="bg-sky-600 px-12 py-5 rounded-full font-bold text-2xl hover:bg-sky-500 transition-all shadow-xl active:scale-95 mb-8">‚ñ∂ Play & Follow</button>
        
        <div class="text-left border-t border-slate-700 pt-6">
            <h3 class="text-[10px] uppercase text-slate-500 mb-4 tracking-widest">Logic Sequence</h3>
            <div class="flex flex-wrap gap-2" id="textNotes"></div>
        </div>
    </div>

    <script>
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const sequence = ${JSON.stringify(recordedSequence)};
        const container = document.getElementById('notesContainer');
        const textContainer = document.getElementById('textNotes');

        // Note positions (percentage from top of staff)
        const noteMap = {
            'C': 105, 'D': 95, 'E': 85, 'F': 75, 'G': 65, 'A': 55, 'B': 45, 'C+': 35
        };

        // Create visual notes
        sequence.forEach((n, i) => {
            const noteEl = document.createElement('div');
            noteEl.className = 'note-head';
            noteEl.id = 'note-' + i;
            noteEl.style.left = (50 + (i * 30)) + 'px';
            noteEl.style.top = noteMap[n.noteName] + '%';
            
            const stem = document.createElement('div');
            stem.className = 'note-stem';
            noteEl.appendChild(stem);
            container.appendChild(noteEl);

            const txt = document.createElement('span');
            txt.className = 'bg-slate-900 text-sky-400 px-3 py-1 rounded-md text-sm font-mono border border-slate-700';
            txt.innerText = n.noteName;
            txt.id = 'txt-' + i;
            textContainer.appendChild(txt);
        });

        function p(f, idx) {
            const o=ctx.createOscillator(); const g=ctx.createGain();
            o.type='sine'; o.frequency.value=f;
            g.gain.setValueAtTime(0.4, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+1);
            o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+1);
            
            // Highlight
            const el = document.getElementById('note-' + idx);
            const txt = document.getElementById('txt-' + idx);
            el.classList.add('playing');
            txt.classList.add('bg-sky-500', 'text-white');
            setTimeout(() => {
                el.classList.remove('playing');
                txt.classList.remove('bg-sky-500', 'text-white');
            }, 500);
        }

        function play() { 
            if(ctx.state==='suspended') ctx.resume(); 
            const s=sequence[0].timestamp; 
            sequence.forEach((x, i)=> {
                setTimeout(()=>p(x.freq, i), x.timestamp-s);
            }); 
        }
    <\/script>
</body></html>`;

        const blob = new Blob([content], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = sName.replace(/\s+/g, '_') + '.html';
        a.click();
    }
</script>

</body>
</html>