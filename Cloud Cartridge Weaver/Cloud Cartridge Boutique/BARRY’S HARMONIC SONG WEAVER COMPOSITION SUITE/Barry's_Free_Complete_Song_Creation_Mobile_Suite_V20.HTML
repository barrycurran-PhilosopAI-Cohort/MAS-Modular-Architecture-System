<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barry's Complete Music Composition Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background: #000000; color: #ffffff; min-height: 100vh; overflow-x: hidden; }
        .studio-card { background: #ffffff; color: #000000; border: 2px solid #ffffff; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .accent-border { border-bottom: 2px solid #000000; }
        .staff-line { stroke: #000000; stroke-width: 1.5; }
        input, select, textarea { background: #ffffff; border: 2px solid #000000; color: #000000; padding: 8px; border-radius: 0px; font-size: 0.8rem; width: 100%; font-weight: 700; appearance: none; }
        label { display: block; font-size: 9px; font-weight: bold; text-transform: uppercase; margin-bottom: 1px; opacity: 0.7; }
        .btn-save-1 { background-color: #C1E1C1; color: #1a1a1a; }
        .btn-save-2 { background-color: #FFD1DC; color: #1a1a1a; }
        .btn-save-3 { background-color: #B2CEFE; color: #1a1a1a; }
        .btn-save-4 { background-color: #FDFD96; color: #1a1a1a; }
        .btn-initiate { background-color: #E0BBE4; color: #1a1a1a; border: 2px solid #000000; }
        .btn-initiate:disabled { background-color: #cccccc !important; cursor: not-allowed; opacity: 0.6; }
        .visual-box { background: #000; position: relative; overflow: hidden; border: 1px solid #333; transition: all 0.2s; min-height: 150px; }
        .teleprompter { background: #ffffff; border: 4px solid #000000; text-align: center; font-size: 1.5rem; font-weight: 800; min-height: 5rem; display: flex; align-items: center; justify-content: center; color: #000000; margin-bottom: 1rem; padding: 1rem; }
        .fx-shape { position: absolute; opacity: 0.8; animation: fadeOut 0.6s forwards; pointer-events: none; }
        @keyframes fadeOut { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
    </style>
</head>
<body class="p-4 md:p-6 flex flex-col items-center">
    <div class="max-w-7xl w-full space-y-4">
        <header class="flex flex-col md:flex-row justify-between items-end border-b-4 border-white pb-4">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter uppercase text-white leading-none">
                    Barry's Complete <span class="text-slate-400">Music Composition Suite</span>
                </h1>
                <p class="text-[10px] text-slate-500 tracking-[0.4em] uppercase mt-2 font-bold italic">Professional Harmonic Engine</p>
            </div>
            <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                <button id="exportPresentationBtn" class="btn-save-1 px-3 py-2 rounded font-bold uppercase text-[9px] shadow-md">1. Save Show</button>
                <button id="saveWavBtn" class="btn-save-2 px-3 py-2 rounded font-bold uppercase text-[9px] shadow-md">2. Audio (.wav)</button>
                <button id="saveSheetBtn" class="btn-save-3 px-3 py-2 rounded font-bold uppercase text-[9px] shadow-md">3. Sheet (.txt)</button>
                <button id="saveLyricsBtn" class="btn-save-4 px-3 py-2 rounded font-bold uppercase text-[9px] shadow-md">4. Lyrics (.txt)</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <aside class="lg:col-span-3 space-y-4">
                <div class="studio-card p-5 space-y-4">
                    <h3 class="text-[11px] font-black uppercase tracking-widest italic accent-border pb-1">Composer Controls</h3>
                    <div>
                        <label>Session Title</label>
                        <input id="sessionTitleInput" type="text" value="New_Masterpiece">
                    </div>
                    <div>
                        <label>Musical Subject</label>
                        <textarea id="promptInput" rows="2" placeholder="Describe the soul of the song..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label>Duration</label>
                            <select id="durationSelect">
                                <option value="10">10 Seconds</option>
                                <option value="30" selected>30 Seconds</option>
                                <option value="60">60 Seconds</option>
                            </select>
                        </div>
                        <div>
                            <label>Scale</label>
                            <select id="scaleSelect">
                                <option value="major">Major</option>
                                <option value="minor">Minor</option>
                                <option value="pentatonic">Pentatonic</option>
                                <option value="blues">Blues</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label>Lead Instrument</label>
                        <select id="leadInst">
                            <option value="acoustic_grand_piano">Piano</option>
                            <option value="acoustic_guitar_steel" selected>Acoustic Guitar (Steel)</option>
                            <option value="distortion_guitar">Electric Guitar</option>
                            <option value="trumpet">Trumpet</option>
                            <option value="tenor_sax">Saxophone</option>
                            <option value="cello">Cello</option>
                        </select>
                    </div>
                    <div>
                        <label>Backing Style</label>
                        <select id="backingStyle">
                            <option value="none">Solo (None)</option>
                            <option value="disco">Disco Pulse</option>
                            <option value="blues">Blues Shuffle</option>
                            <option value="jazz">Jazz Walking</option>
                            <option value="waltz">Classic Waltz</option>
                        </select>
                    </div>
                    <button id="renderBtn" class="w-full btn-initiate py-3 font-black uppercase text-xs tracking-widest">INITIATE BROADCAST</button>
                </div>
                <div class="studio-card p-4">
                    <div id="lyricsContent" class="text-[11px] font-bold italic leading-tight text-center whitespace-pre-line max-h-48 overflow-y-auto">Awaiting input...</div>
                </div>
            </aside>

            <main class="lg:col-span-9 space-y-4">
                <div class="studio-card p-6">
                    <div id="liveTeleprompter" class="teleprompter">READY...</div>
                    <div class="bg-white border-4 border-black p-4 overflow-x-auto relative">
                        <svg id="studioStaff" viewBox="0 0 2000 200" class="h-32 w-full">
                            <g id="clefLayer">
                                <path d="M25,145 c0,-10 15,-30 15,-55 c0,-20 -10,-35 -20,-35 c-5,0 -10,5 -10,10 c0,10 20,5 20,25 c0,25 -25,45 -25,75 c0,20 15,35 35,35 c25,0 45,-20 45,-55 c0,-50 -40,-90 -40,-130 c0,-15 5,-20 10,-20 c5,0 10,5 10,25 l0,140" fill="none" stroke="black" stroke-width="2" transform="scale(0.8) translate(10, 20)"/>
                            </g>
                            <line x1="0" y1="60" x2="2000" y2="60" class="staff-line" />
                            <line x1="0" y1="80" x2="2000" y2="80" class="staff-line" />
                            <line x1="0" y1="100" x2="2000" y2="100" class="staff-line" />
                            <line x1="0" y1="120" x2="2000" y2="120" class="staff-line" />
                            <line x1="0" y1="140" x2="2000" y2="140" class="staff-line" />
                            <g id="noteContainer"></g>
                        </svg>
                    </div>
                </div>
                <div id="visualGrid" class="grid grid-cols-3 gap-2">
                    <div id="vis0" class="aspect-video visual-box"></div>
                    <div id="vis1" class="aspect-video visual-box"></div>
                    <div id="vis2" class="aspect-video visual-box"></div>
                </div>
                <div class="flex gap-2">
                    <button id="abortBtn" onclick="stopAll()" class="flex-1 py-4 border-4 border-white text-white font-black uppercase text-xs tracking-widest hover:bg-white hover:text-black transition-colors">ABORT BROADCAST</button>
                    <button id="clearResetBtn" onclick="resetStudio()" class="px-8 py-4 bg-red-600 border-4 border-red-600 text-white font-black uppercase text-xs tracking-widest hover:bg-white hover:text-red-600 transition-colors">CLEAR & RESET</button>
                </div>
            </main>
        </div>
    </div>

    <script>
        const apiKey = "";
        let audioCtx, leadPlayer, backPlayer, drumPlayer, isPlaying = false;
        let currentLyrics = "", lyricLines = [], currentTitle = "SESSION", activeFileName = "Song";
        let recordedNotes = [], performanceInterval = null;
        let recordedChunks = [], mediaRecorder = null;

        const MIDI_MAP = { 60:'C4', 62:'D4', 64:'E4', 65:'F4', 67:'G4', 69:'A4', 71:'B4', 72:'C5' };
        // Map MIDI to Staff Positions for ASCII
        const STAFF_MAP = {
            72: 0, // C5 (Space above top line)
            71: 1, // B4 (Top line)
            69: 2, // A4 (Space)
            67: 3, // G4 (Line)
            65: 4, // F4 (Space)
            64: 5, // E4 (Line)
            62: 6, // D4 (Space)
            60: 7  // C4 (Middle C / Ledger line)
        };

        const SCALES = { 
            major: [60, 62, 64, 65, 67, 69, 71, 72], 
            minor: [60, 62, 63, 65, 67, 68, 70, 72],
            pentatonic: [60, 62, 64, 67, 69, 72],
            blues: [60, 63, 65, 66, 67, 70, 72]
        };
        const COLORS = ['#FFD1DC', '#B2CEFE', '#C1E1C1', '#FDFD96', '#E0BBE4', '#FFFFFF'];

        async function startStudio() {
            if(isPlaying) return; 

            const renderBtn = document.getElementById('renderBtn');
            renderBtn.disabled = true;
            renderBtn.textContent = "BROADCAST INITIATED...";

            activeFileName = document.getElementById('sessionTitleInput').value.trim().replace(/[^a-z0-9]/gi, '_');
            const prompt = document.getElementById('promptInput').value || "Music and Magic";
            await generateAIContent(prompt);
            
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            
            leadPlayer = await Soundfont.instrument(audioCtx, document.getElementById('leadInst').value, { destination: dest });
            backPlayer = await Soundfont.instrument(audioCtx, 'electric_bass_finger', { destination: dest });
            drumPlayer = await Soundfont.instrument(audioCtx, 'woodblock', { destination: dest });
            
            leadPlayer.connect(audioCtx.destination);
            backPlayer.connect(audioCtx.destination);
            drumPlayer.connect(audioCtx.destination);

            recordedChunks = [];
            mediaRecorder = new MediaRecorder(dest.stream);
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.start();
            
            isPlaying = true;
            recordedNotes = [];
            document.getElementById('noteContainer').innerHTML = '';
            runEngine(document.getElementById('scaleSelect').value, parseInt(document.getElementById('durationSelect').value));
        }

        async function generateAIContent(p) {
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: p }] }],
                        systemInstruction: { parts: [{ text: `Respond ONLY with JSON: {"title": "Title", "lyrics": "Lyrics line 1\\nLine 2"}` }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const d = await r.json();
                const j = JSON.parse(d.candidates[0].content.parts[0].text);
                currentTitle = j.title || "Untitled";
                currentLyrics = j.lyrics || "";
                lyricLines = currentLyrics.split('\n').filter(l => l.length > 0);
                document.getElementById('lyricsContent').innerText = currentLyrics;
            } catch(e) {
                currentTitle = "THE UNKNOWN";
                lyricLines = ["Melody in the static", "Rhythm in the void"];
            }
        }

        function spawnVisual(boxId) {
            const box = document.getElementById(boxId);
            if(!box) return;
            const shape = document.createElement('div');
            shape.className = 'fx-shape';
            const size = Math.random() * 80 + 20;
            shape.style.width = size + 'px';
            shape.style.height = size + 'px';
            shape.style.left = Math.random() * 80 + '%';
            shape.style.top = Math.random() * 80 + '%';
            shape.style.backgroundColor = COLORS[Math.floor(Math.random() * COLORS.length)];
            const type = Math.floor(Math.random() * 3);
            if(type === 0) shape.style.borderRadius = '50%';
            else if(type === 1) shape.style.borderRadius = '0px';
            else { shape.style.height = '2px'; shape.style.width = '100%'; shape.style.left = '0'; }
            box.appendChild(shape);
            setTimeout(() => shape.remove(), 600);
        }

        function runEngine(scaleKey, dur) {
            let step = 0; 
            const beat = 0.5; 
            const max = Math.floor(dur / beat);
            const style = document.getElementById('backingStyle').value;

            performanceInterval = setInterval(() => {
                if(step >= max || !isPlaying) { stopAll(); return; }
                const scale = SCALES[scaleKey];
                const note = scale[Math.floor(Math.random() * scale.length)];
                leadPlayer.play(note, audioCtx.currentTime, { duration: 0.4 });
                
                if (style !== 'none') {
                    drumPlayer.play(60, audioCtx.currentTime, { duration: 0.1, gain: 0.3 });
                    let bassNote = scale[0] - 12;
                    if (style === 'disco' && step % 2 === 0) backPlayer.play(bassNote, audioCtx.currentTime, { duration: 0.2 });
                    else if (style === 'jazz') {
                        const walk = [0, 4, 7, 9][step % 4];
                        backPlayer.play(bassNote + walk, audioCtx.currentTime, { duration: 0.3 });
                    } else if (style === 'blues' && step % 4 !== 3) backPlayer.play(bassNote, audioCtx.currentTime, { duration: 0.2 });
                    else if (style === 'waltz') {
                        if (step % 3 === 0) backPlayer.play(bassNote, audioCtx.currentTime, { duration: 0.4 });
                        else drumPlayer.play(62, audioCtx.currentTime, { duration: 0.1, gain: 0.2 });
                    }
                }

                const lyric = lyricLines[step % lyricLines.length] || "...";
                recordedNotes.push({ note, step, lyric, timeOffset: step * beat });
                drawNote(note, step);
                document.getElementById('liveTeleprompter').textContent = lyric;
                spawnVisual('vis0'); spawnVisual('vis1'); spawnVisual('vis2');
                step++;
            }, beat * 1000);
        }

        function drawNote(midi, step) {
            const container = document.getElementById('noteContainer');
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("cx", 80 + (step * 35));
            c.setAttribute("cy", 140 - ((midi - 60) * 8));
            c.setAttribute("r", "5");
            c.setAttribute("fill", "black");
            container.appendChild(c);
        }

        function stopAll() {
            isPlaying = false;
            if(performanceInterval) clearInterval(performanceInterval);
            if(mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
            document.getElementById('liveTeleprompter').textContent = "BROADCAST ENDED";
            
            const renderBtn = document.getElementById('renderBtn');
            renderBtn.disabled = false;
            renderBtn.textContent = "INITIATE BROADCAST";
        }

        function resetStudio() {
            stopAll();
            document.getElementById('noteContainer').innerHTML = '';
            document.getElementById('liveTeleprompter').textContent = 'READY...';
            document.getElementById('lyricsContent').innerText = 'Awaiting input...';
            document.getElementById('promptInput').value = '';
            ['vis0', 'vis1', 'vis2'].forEach(id => document.getElementById(id).innerHTML = '');
            recordedNotes = [];
            recordedChunks = [];
        }

        function downloadFile(content, filename, type) {
            const blob = (content instanceof Blob) ? content : new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateAsciiSheet() {
            if (recordedNotes.length === 0) return "No notes recorded yet.";
            
            let sheet = `BARRY'S COMPOSITION SUITE: ${currentTitle.toUpperCase()}\n`;
            sheet += `LEAD INSTRUMENT: ${document.getElementById('leadInst').value.replace(/_/g, ' ')}\n`;
            sheet += "=".repeat(60) + "\n\n";

            // We divide notes into blocks of 8 for readability
            for (let i = 0; i < recordedNotes.length; i += 8) {
                const chunk = recordedNotes.slice(i, i + 8);
                
                // Staff Lines (5 lines, 4 spaces)
                const lines = [
                    " F5 ----------------------------------------------------",
                    " E5                                                     ",
                    " D5 ----------------------------------------------------",
                    " C5                                                     ",
                    " B4 ----------------------------------------------------",
                    " A4                                                     ",
                    " G4 ----------------------------------------------------",
                    " F4                                                     ",
                    " E4 ----------------------------------------------------"
                ];

                // Note positions relative to MIDI
                // 72=C5, 71=B4, 69=A4, 67=G4, 65=F4, 64=E4, 62=D4, 60=C4
                // Let's refine the ASCII mapping
                const asciiMap = {
                    72: 1, 71: 2, 69: 3, 67: 4, 65: 5, 64: 6, 62: 7, 60: 8
                };

                chunk.forEach((n, idx) => {
                    const pos = asciiMap[n.note] || 4; // Default to G4 if unknown
                    const horizontalPos = 10 + (idx * 6);
                    const lineStr = lines[pos];
                    lines[pos] = lineStr.substring(0, horizontalPos) + " (O) " + lineStr.substring(horizontalPos + 5);
                });

                sheet += lines.join("\n") + "\n";
                
                // Add the Letter Names below the staff
                let lettersLine = "    ";
                chunk.forEach(n => {
                    lettersLine += `  ${MIDI_MAP[n.note] || '??'}  `;
                });
                sheet += lettersLine + "\n\n" + "-".repeat(60) + "\n\n";
            }
            
            return sheet;
        }

        document.getElementById('saveSheetBtn').onclick = () => {
            const sheet = generateAsciiSheet();
            downloadFile(sheet, `${activeFileName}_Musical_Notation.txt`, 'text/plain');
        };

        document.getElementById('exportPresentationBtn').onclick = () => {
            const activeTitle = document.getElementById('sessionTitleInput').value.trim() || currentTitle;
            const payload = JSON.stringify({ 
                title: activeTitle, 
                notes: recordedNotes, 
                instrument: document.getElementById('leadInst').value,
                style: document.getElementById('backingStyle').value
            });
            const html = `<!DOCTYPE html><html><head><title>${activeTitle}</title><script src="https://cdn.tailwindcss.com"><\/script><script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"><\/script><style>body{background:#000;color:#fff;text-align:center;font-family:sans-serif;overflow:hidden;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;}.box{position:absolute;opacity:0.6;animation:fx 0.5s forwards;}@keyframes fx{0%{transform:scale(0.5);opacity:1;}100%{transform:scale(2);opacity:0;}}#t{font-size:4rem;font-weight:900;background:white;color:black;padding:40px;border:20px solid black;z-index:100;}#staff{background:white;width:90%;padding:20px;border:10px solid black;margin-top:20px;}<\/style><\/head><body><div id="t">CLICK TO REPLAY<\/div><div id="staff"><svg viewBox="0 0 2000 200" style="width:100%;height:100px;"><line x1="0" y1="60" x2="2000" y2="60" stroke="black"/><line x1="0" y1="80" x2="2000" y2="80" stroke="black"/><line x1="0" y1="100" x2="2000" y2="100" stroke="black"/><line x1="0" y1="120" x2="2000" y2="120" stroke="black"/><line x1="0" y1="140" x2="2000" y2="140" stroke="black"/><g id="n"><\/g><\/svg><\/div><script>const d = ${payload};document.body.onclick = async () => { if(window.played) return; window.played=true; const ac = new AudioContext(); const p = await Soundfont.instrument(ac, d.instrument); const b = await Soundfont.instrument(ac, 'electric_bass_finger'); const dr = await Soundfont.instrument(ac, 'woodblock'); d.notes.forEach(note => { setTimeout(() => { p.play(note.note); if(d.style !== 'none'){ dr.play(60, ac.currentTime, {gain:0.3}); if(note.step % 2 === 0) b.play(note.note - 24, ac.currentTime, {gain:0.5}); } document.getElementById('t').innerText = note.lyric; const c = document.createElementNS("http://www.w3.org/2000/svg", "circle"); c.setAttribute("cx", 80 + (note.step * 35)); c.setAttribute("cy", 140 - ((note.note - 60) * 8)); c.setAttribute("r", "6"); document.getElementById('n').appendChild(c); const v = document.createElement('div'); v.className='box'; v.style.width='100px'; v.style.height='100px'; v.style.left=Math.random()*90+'%'; v.style.top=Math.random()*90+'%'; v.style.background=['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)]; document.body.appendChild(v); setTimeout(()=>v.remove(), 500); }, note.timeOffset * 1000); }); };<\/script><\/body><\/html>`;
            downloadFile(html, `${activeFileName}_Show.html`, 'text/html');
        };

        document.getElementById('saveWavBtn').onclick = () => {
            if (!recordedChunks.length) return;
            downloadFile(new Blob(recordedChunks, { type: 'audio/wav' }), `${activeFileName}.wav`);
        };

        document.getElementById('saveLyricsBtn').onclick = () => {
            downloadFile(`TITLE: ${currentTitle}\n\n${currentLyrics}`, `${activeFileName}_Lyrics.txt`, 'text/plain');
        };

        document.getElementById('renderBtn').onclick = startStudio;
    </script>
</body>
</html>