<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocalist Pro Elite - Granular TTS Mastering Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e5e5; min-height: 100vh; }
        .glass-panel { background: rgba(23, 23, 23, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gradient-text { background: linear-gradient(to right, #60a5fa, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-primary { background: linear-gradient(to bottom right, #3b82f6, #8b5cf6); transition: all 0.3s ease; }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-primary:disabled { background: #404040; cursor: not-allowed; opacity: 0.7; }
        
        .chunk-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; }
        .chunk-card.active-edit { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .chunk-card.completed { border-color: rgba(34, 197, 94, 0.2); }
        
        .loader { border: 2px solid rgba(255,255,255,0.2); border-top: 2px solid #fff; border-radius: 50%; width: 14px; height: 14px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .drop-active { border-color: #3b82f6 !important; background: rgba(59, 130, 246, 0.05) !important; box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center">

    <div class="max-w-6xl w-full space-y-6">
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 text-center md:text-left">
            <div>
                <h1 class="text-4xl font-extrabold tracking-tight gradient-text leading-none">VOCALIST PRO ELITE</h1>
                <p class="text-neutral-500 text-[10px] font-bold tracking-[0.2em] uppercase mt-1">Granular TTS Mastering Suite • Edit • Generate • Master</p>
            </div>
            <div id="statusContainer" class="hidden glass-panel px-6 py-3 rounded-2xl flex items-center gap-4">
                <span id="statusText" class="text-[10px] font-bold text-blue-400 uppercase tracking-tighter">Ready</span>
                <div class="w-32 bg-neutral-800 rounded-full h-1 overflow-hidden">
                    <div id="progressBar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left: Editor & Workspace -->
            <div class="lg:col-span-4 space-y-4">
                <div id="dropZone" class="glass-panel rounded-3xl p-6 space-y-4 relative overflow-hidden transition-all duration-200 border border-white/10">
                    <div id="editBadge" class="hidden absolute top-0 right-0 bg-blue-600 text-white text-[9px] font-black px-4 py-1 rounded-bl-xl uppercase tracking-widest animate-pulse">
                        Editing Segment
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-end pb-1">
                            <label id="editorLabel" class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Script Workspace</label>
                            <div class="flex items-center gap-3">
                                <span id="charCount" class="text-[10px] text-neutral-600 font-mono">0 chars</span>
                                <!-- RESET BUTTON -->
                                <button id="resetBtn" title="Wipe entire session" class="flex items-center gap-1.5 px-2 py-0.5 rounded-lg border border-white/5 bg-white/5 hover:bg-red-500/10 hover:border-red-500/30 transition-all group">
                                    <svg class="w-3 h-3 text-neutral-600 group-hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    <span class="text-[9px] font-bold text-neutral-600 group-hover:text-red-500 uppercase tracking-tighter">Reset</span>
                                </button>
                            </div>
                        </div>
                        <textarea id="textInput" 
                            placeholder="Drop a .txt file or paste script..."
                            class="w-full h-[500px] bg-neutral-900/50 border border-neutral-800 rounded-2xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all resize-none"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-neutral-600 uppercase ml-1">Master Voice</label>
                            <select id="voiceSelect" class="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-2 text-xs focus:outline-none">
                                <option value="Iapetus" selected>Iapetus (Deep)</option>
                                <option value="Zephyr">Zephyr (Modern)</option>
                                <option value="Kore">Kore (Smooth)</option>
                                <option value="Aoede">Aoede (Clear)</option>
                            </select>
                        </div>
                        <div class="flex flex-col justify-end">
                            <button id="prepareBtn" class="h-10 rounded-xl bg-white/5 border border-white/10 font-bold text-[10px] uppercase hover:bg-white/10 transition-all">
                                Chunk Text
                            </button>
                        </div>
                    </div>

                    <!-- Side Actions (Appear during Segment Edit) -->
                    <div id="editActions" class="hidden space-y-2 pt-2 border-t border-white/5">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="cancelEditBtn" class="h-12 rounded-xl bg-neutral-800 text-neutral-400 font-bold text-[10px] uppercase">Cancel Edit</button>
                            <button id="saveEditBtn" class="h-12 rounded-xl bg-blue-600 text-white font-bold text-[10px] uppercase">Update Segment</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Segment Management & Master Mix -->
            <div class="lg:col-span-8 flex flex-col h-full gap-6">
                <!-- Segment List -->
                <div id="chunkList" class="flex-grow space-y-3 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar border-b border-white/5 pb-4">
                    <div class="flex flex-col items-center justify-center py-40 text-neutral-600 border-2 border-dashed border-neutral-800 rounded-3xl">
                        <svg class="w-12 h-12 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        <p class="text-sm font-medium">Ready for Granular Processing</p>
                    </div>
                </div>

                <!-- Batch Actions -->
                <div id="batchActionArea" class="hidden flex flex-col md:flex-row gap-4">
                    <button id="batchBtn" disabled class="btn-primary flex-grow h-14 rounded-2xl font-black text-xs uppercase tracking-widest disabled:opacity-30">
                        Synthesize All Segments
                    </button>
                    <!-- Reconstruct Button -->
                    <button id="reconstructBtn" title="Pull all edited segments back into the main text editor" class="px-6 rounded-2xl border border-white/10 text-neutral-400 font-bold text-[9px] uppercase hover:bg-white/5 transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Reconstruct Global Script
                    </button>
                </div>

                <!-- Master Output -->
                <div id="masterOutput" class="hidden glass-panel rounded-3xl p-6 space-y-4 border-blue-500/30">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Master Production</span>
                            <p class="text-[9px] text-neutral-500 mt-0.5">Stitch processed segments into final master file</p>
                        </div>
                        <button id="stitchBtn" class="bg-blue-600 text-white px-8 py-3 rounded-full text-[10px] font-black uppercase shadow-lg shadow-blue-500/20 hover:scale-105 transition-transform">Stitch Master Mix</button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 items-center border-t border-white/5 pt-4">
                        <audio id="audioPlayer" controls class="w-full h-10"></audio>
                        <button id="downloadBtn" class="w-full md:w-64 h-10 rounded-xl bg-white/5 border border-white/5 text-[10px] font-bold uppercase hover:bg-white/10 transition-colors">Download Master .wav</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let segments = []; 
        let currentEditIndex = null;
        let isBatching = false;
        let masterBlob = null;
        const apiKey = ""; 

        const ui = {
            input: document.getElementById('textInput'),
            dropZone: document.getElementById('dropZone'),
            voice: document.getElementById('voiceSelect'),
            prepare: document.getElementById('prepareBtn'),
            chunkList: document.getElementById('chunkList'),
            batchBtn: document.getElementById('batchBtn'),
            batchActionArea: document.getElementById('batchActionArea'),
            stitchBtn: document.getElementById('stitchBtn'),
            status: document.getElementById('statusContainer'),
            statusText: document.getElementById('statusText'),
            progressBar: document.getElementById('progressBar'),
            audioPlayer: document.getElementById('audioPlayer'),
            downloadBtn: document.getElementById('downloadBtn'),
            masterOutput: document.getElementById('masterOutput'),
            charCount: document.getElementById('charCount'),
            editBadge: document.getElementById('editBadge'),
            editorLabel: document.getElementById('editorLabel'),
            editActions: document.getElementById('editActions'),
            cancelEdit: document.getElementById('cancelEditBtn'),
            saveEdit: document.getElementById('saveEditBtn'),
            resetBtn: document.getElementById('resetBtn'),
            reconstructBtn: document.getElementById('reconstructBtn')
        };

        // UI HELPERS
        function updateCharCount() { ui.charCount.innerText = `${ui.input.value.length} chars`; }
        ui.input.addEventListener('input', updateCharCount);

        // DRAG AND DROP
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            ui.dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            ui.dropZone.addEventListener(eventName, () => {
                ui.dropZone.classList.add('drop-active');
                if (currentEditIndex === null) ui.editorLabel.innerText = "Drop to Append";
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            ui.dropZone.addEventListener(eventName, () => {
                ui.dropZone.classList.remove('drop-active');
                if (currentEditIndex === null) ui.editorLabel.innerText = "Script Workspace";
            }, false);
        });

        ui.dropZone.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            if (files && files[0] && (files[0].type === "text/plain" || files[0].name.endsWith('.txt'))) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const currentVal = ui.input.value;
                    ui.input.value = currentVal + (currentVal ? "\n\n" : "") + event.target.result;
                    updateCharCount();
                };
                reader.readAsText(files[0]);
            }
        });

        // GLOBAL RESET - FULL HARD RESET
        ui.resetBtn.addEventListener('click', () => {
            if(confirm("Confirm: Clear entire project and start over?")) {
                // 1. Clear data state
                segments = [];
                masterBlob = null;
                currentEditIndex = null;
                isBatching = false;
                
                // 2. Clear Primary Input
                ui.input.value = "";
                updateCharCount();
                
                // 3. Clear Audio elements
                ui.audioPlayer.src = "";
                ui.audioPlayer.pause();
                ui.audioPlayer.removeAttribute('src'); 
                ui.audioPlayer.load();
                
                // 4. Reset UI visibility
                ui.masterOutput.classList.add('hidden');
                ui.status.classList.add('hidden');
                ui.batchActionArea.classList.add('hidden');
                ui.progressBar.style.width = '0%';
                ui.statusText.innerText = "Ready";
                
                // 5. Cleanup editing modes
                exitEditMode(); 
                
                // 6. Force render empty list
                renderSegments();
            }
        });

        // RECONSTRUCT GLOBAL SCRIPT
        ui.reconstructBtn.addEventListener('click', () => {
            if (segments.length === 0) return;
            const fullText = segments.map(s => s.text).join('\n\n');
            ui.input.value = fullText;
            updateCharCount();
            if (currentEditIndex !== null) exitEditMode();
            ui.input.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => ui.input.classList.remove('ring-2', 'ring-blue-500'), 500);
        });

        // CHUNKING
        ui.prepare.addEventListener('click', () => {
            const text = ui.input.value.trim();
            if (!text) return;
            segments = [];
            const TARGET_SIZE = 2500;
            let i = 0;
            while (i < text.length) {
                let end = i + TARGET_SIZE;
                if (end < text.length) {
                    const window = text.substring(end, end + 1000);
                    const match = window.match(/[.!?](\s|\n|$)/);
                    if (match) end = end + match.index + 1;
                    else {
                        const lastSpace = text.lastIndexOf(' ', end + 200);
                        if (lastSpace > i) end = lastSpace;
                    }
                }
                const chunkText = text.substring(i, end).trim();
                if (chunkText) segments.push({ text: chunkText, pcm: null });
                i = end;
            }
            renderSegments();
            ui.status.classList.remove('hidden');
            ui.batchBtn.disabled = false;
            ui.batchActionArea.classList.remove('hidden');
            ui.masterOutput.classList.remove('hidden');
        });

        // RENDERING
        function renderSegments() {
            if (segments.length === 0) {
                ui.chunkList.innerHTML = `<div class="flex flex-col items-center justify-center py-40 text-neutral-600 border-2 border-dashed border-neutral-800 rounded-3xl">
                    <svg class="w-12 h-12 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    <p class="text-sm font-medium">Ready for Granular Processing</p>
                </div>`;
                return;
            }
            ui.chunkList.innerHTML = '';
            segments.forEach((seg, idx) => {
                const card = document.createElement('div');
                card.className = `chunk-card p-5 rounded-2xl flex flex-col md:flex-row items-start md:items-center justify-between gap-4 ${seg.pcm ? 'completed' : ''} ${currentEditIndex === idx ? 'active-edit' : ''}`;
                card.id = `seg-${idx}`;
                const previewText = seg.text.substring(0, 140) + (seg.text.length > 140 ? '...' : '');
                card.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-white/5 text-[9px] font-black px-2 py-0.5 rounded text-neutral-500 uppercase tracking-widest">SEG ${idx + 1}</span>
                            <span class="text-[9px] text-neutral-600 font-mono">${seg.text.length} chars</span>
                            ${seg.pcm ? '<span class="text-[9px] text-green-500 font-black uppercase tracking-widest">● Cached</span>' : ''}
                        </div>
                        <p class="text-xs text-neutral-400 italic">"${previewText}"</p>
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto shrink-0">
                        ${seg.pcm ? `<button onclick="playSegment(${idx})" class="flex-1 md:flex-none text-[10px] font-bold text-green-400 bg-green-500/10 px-4 py-2 rounded-xl">Play</button>` : 
                        `<button onclick="processSingle(${idx})" id="btn-sync-${idx}" class="flex-1 md:flex-none text-[10px] font-bold text-blue-400 bg-blue-500/10 px-4 py-2 rounded-xl">Generate</button>`}
                        <button onclick="enterEditMode(${idx})" class="flex-1 md:flex-none text-[10px] font-bold text-neutral-400 bg-white/5 px-4 py-2 rounded-xl hover:bg-white/10">Edit</button>
                    </div>
                `;
                ui.chunkList.appendChild(card);
            });
        }

        // EDIT MODE LOGIC
        window.enterEditMode = (idx) => {
            currentEditIndex = idx;
            ui.input.value = segments[idx].text;
            updateCharCount();
            ui.editBadge.classList.remove('hidden');
            ui.editorLabel.innerText = `Segment ${idx + 1} Editor`;
            ui.editActions.classList.remove('hidden');
            ui.prepare.disabled = true;
            renderSegments();
            const target = document.getElementById(`seg-${idx}`);
            if(target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        ui.cancelEdit.addEventListener('click', exitEditMode);
        
        ui.saveEdit.addEventListener('click', async () => {
            if (currentEditIndex === null) return;
            segments[currentEditIndex].text = ui.input.value.trim();
            segments[currentEditIndex].pcm = null; 
            const idxToReSync = currentEditIndex;
            exitEditMode();
            await window.processSingle(idxToReSync);
        });

        function exitEditMode() {
            currentEditIndex = null;
            ui.input.value = "";
            updateCharCount();
            ui.editBadge.classList.add('hidden');
            ui.editorLabel.innerText = "Script Workspace";
            ui.editActions.classList.add('hidden');
            ui.prepare.disabled = false;
            renderSegments();
        }

        // TTS ENGINE
        async function fetchAudio(text, voice, attempt = 1) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                        }
                    })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();
                const b64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                const binary = atob(b64);
                const bytes = new Uint8Array(binary.length);
                for (let j = 0; j < binary.length; j++) bytes[j] = binary.charCodeAt(j);
                return bytes;
            } catch (err) {
                if (attempt < 5) {
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
                    return fetchAudio(text, voice, attempt + 1);
                }
                throw err;
            }
        }

        window.processSingle = async (idx) => {
            const btn = document.getElementById(`btn-sync-${idx}`);
            if (btn) btn.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                segments[idx].pcm = await fetchAudio(segments[idx].text, ui.voice.value);
                renderSegments();
            } catch (e) {
                if (btn) btn.innerText = "Err";
            }
        };

        ui.batchBtn.addEventListener('click', async () => {
            if (isBatching) return;
            isBatching = true;
            ui.batchBtn.disabled = true;
            for (let i = 0; i < segments.length; i++) {
                if (segments[i].pcm) continue;
                ui.statusText.innerText = `Synthesizing: ${i + 1}/${segments.length}`;
                ui.progressBar.style.width = `${((i+1) / segments.length) * 100}%`;
                try {
                    segments[i].pcm = await fetchAudio(segments[i].text, ui.voice.value);
                    renderSegments();
                } catch (e) { i--; await new Promise(r => setTimeout(r, 4000)); }
            }
            ui.statusText.innerText = "Processing Complete";
            isBatching = false;
            ui.batchBtn.disabled = false;
        });

        // STITCHING & PLAYBACK
        ui.stitchBtn.addEventListener('click', () => {
            const completed = segments.filter(s => s.pcm);
            if (completed.length === 0) return;
            const totalSize = completed.reduce((acc, s) => acc + s.pcm.length, 0);
            const masterPcm = new Uint8Array(totalSize);
            let offset = 0;
            segments.forEach(seg => {
                if (seg.pcm) {
                    masterPcm.set(seg.pcm, offset);
                    offset += seg.pcm.length;
                }
            });
            const wav = pcmToWav(masterPcm, 24000);
            masterBlob = new Blob([wav], { type: 'audio/wav' });
            ui.audioPlayer.src = URL.createObjectURL(masterBlob);
            ui.audioPlayer.play();
        });

        window.playSegment = (idx) => {
            const wav = pcmToWav(segments[idx].pcm, 24000);
            const blob = new Blob([wav], { type: 'audio/wav' });
            new Audio(URL.createObjectURL(blob)).play();
        };

        ui.downloadBtn.addEventListener('click', () => {
            if (!masterBlob) return;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(masterBlob);
            a.download = `VPE_MASTER_${Date.now()}.wav`;
            a.click();
        });

        function pcmToWav(bytes, sampleRate) {
            const len = bytes.length;
            const buffer = new ArrayBuffer(44 + len);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + len, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, len, true);
            new Uint8Array(buffer, 44).set(bytes);
            return buffer;
        }
    </script>
</body>
</html>